- name: Extract and Replace Frontend Files Only
  uses: appleboy/ssh-action@v1.0.3
  with:
    host: ${{ secrets.SERVER_HOST }}
    username: ${{ secrets.SERVER_USER }}
    key: ${{ secrets.SSH_PRIVATE_KEY }}
    script: |
      # Extract to temporary directory
      mkdir -p /home/thafheem/temp_deploy
      tar -xzf /home/thafheem/deploy.tar.gz -C /home/thafheem/temp_deploy
      
      # Navigate to website folder
      cd ${{ secrets.DEPLOY_PATH }}
      
      # Backup existing .htaccess if it exists
      if [ -f ".htaccess" ]; then
        cp .htaccess .htaccess.backup
      fi
      
      # Remove old frontend files
      rm -rf ./assets ./fonts ./articles
      rm -f ./index.html ./service-worker.js ./manifest.json ./robots.txt ./favicon.ico ./vite.svg
      
      # Copy ONLY frontend files from temp directory
      if [ -d /home/thafheem/temp_deploy/assets ]; then
        cp -r /home/thafheem/temp_deploy/assets .
        echo "✓ Copied assets/"
      fi
      if [ -d /home/thafheem/temp_deploy/fonts ]; then
        cp -r /home/thafheem/temp_deploy/fonts .
        echo "✓ Copied fonts/"
      fi
      if [ -d /home/thafheem/temp_deploy/articles ]; then
        cp -r /home/thafheem/temp_deploy/articles .
        echo "✓ Copied articles/"
      fi
      if [ -f /home/thafheem/temp_deploy/index.html ]; then
        cp /home/thafheem/temp_deploy/index.html .
        echo "✓ Copied index.html"
      fi
      if [ -f /home/thafheem/temp_deploy/service-worker.js ]; then
        cp /home/thafheem/temp_deploy/service-worker.js .
        echo "✓ Copied service-worker.js"
      fi
      if [ -f /home/thafheem/temp_deploy/manifest.json ]; then
        cp /home/thafheem/temp_deploy/manifest.json .
        echo "✓ Copied manifest.json"
      fi
      if [ -f /home/thafheem/temp_deploy/robots.txt ]; then
        cp /home/thafheem/temp_deploy/robots.txt .
        echo "✓ Copied robots.txt"
      fi
      if [ -f /home/thafheem/temp_deploy/favicon.ico ]; then
        cp /home/thafheem/temp_deploy/favicon.ico .
        echo "✓ Copied favicon.ico"
      fi
      if [ -f /home/thafheem/temp_deploy/vite.svg ]; then
        cp /home/thafheem/temp_deploy/vite.svg .
        echo "✓ Copied vite.svg"
      fi
      
      # Restore .htaccess if it was backed up
      if [ -f ".htaccess.backup" ]; then
        mv .htaccess.backup .htaccess
      fi
      
      # Cleanup temporary files
      rm -rf /home/thafheem/temp_deploy
      rm /home/thafheem/deploy.tar.gz
      
      # Set correct permissions for frontend files
      chown -R thafheem:thafheem ./assets ./fonts ./articles ./index.html ./service-worker.js ./manifest.json ./robots.txt ./favicon.ico ./vite.svg 2>/dev/null || true
      find ./assets ./fonts ./articles -type d -exec chmod 755 {} \; 2>/dev/null || true
      find ./assets ./fonts ./articles -type f -exec chmod 644 {} \; 2>/dev/null || true
      chmod 644 ./index.html ./service-worker.js ./manifest.json ./robots.txt ./favicon.ico ./vite.svg 2>/dev/null || true
      
      echo "Deployment completed successfully"