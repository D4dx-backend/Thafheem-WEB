import{a as ir,u as cr,m as ur,A as dr,j as r,T as mr,C as fr,D as pr,P as hr,B as gr,F as yr,p as xr,x as Xe,q as br,r as Tt,X as kr,E as wr,o as vr,G as Nr}from"./index-D0NMIq43.js";import{b as s,u as Ar,e as Sr,d as Br}from"./react-vendor-v5ei6ytj.js";import{u as Er,T as Ge}from"./Toast-Bf4bwsOE.js";import{s as Ct,W as Tr,M as Cr,h as jr,p as $r}from"./WordByWord-CWAAPupz.js";import jt from"./InterpretationBlockwise-bzGSXxyX.js";import{a as Ye,b as $t,D as Ir,B as Wr,C as Pr,A as Je}from"./LoadingSkeleton-BaxG_oO1.js";import Rr from"./StickyAudioPlayer-Cxr1kIJb.js";import Ze from"./englishTranslationService-TExHbstj.js";import{u as Fr}from"./useSequentialEnglishFootnotes-B4d1JHKd.js";import{g as Lr,s as Mr}from"./surahNameUtils-BTvJ0ckf.js";import{C as It}from"./chevron-left-B6PCEYk2.js";import"./tamilWordByWordService-C7rMpoKH.js";import"./apiService-Be4cmTqe.js";import"./hindiWordByWordService-BZeSq7qs.js";import"./banglaWordByWordService-BITaT-vc.js";import"./banglaTranslationService-CCMvLMqe.js";import"./tamilTranslationService-D-704-MC.js";import"./hindiTranslationService-CFRwMbcP.js";import"./urduTranslationService-D6XDtXQ4.js";import"./BlockInterpretationModal-ChQ-ZZJT.js";import"./InterpretationNavbar-6fKJEcm-.js";import"./WordByWordIcon-DrlWBNwO.js";import"./volume-x-C8BF0xN2.js";import"./skip-forward-BY6SBxtt.js";const wn=()=>{const[Or,_r]=s.useState("Translation"),[Dr,Ur]=s.useState("Block wise"),[Wt,je]=s.useState(!1),[$e,et]=s.useState(null),[z,tt]=s.useState(()=>localStorage.getItem("reciter")||"al-hudaify"),[ie,Ie]=s.useState(["quran"]),[_,rt]=s.useState(()=>{const e=localStorage.getItem("playbackSpeed");return e?parseFloat(e):1}),[E,D]=s.useState(null),[Vr,X]=s.useState(null),[P,M]=s.useState(null),[Pt,F]=s.useState(1),[O,L]=s.useState(!1),[G,R]=s.useState(!1),a=s.useRef(null),$=s.useRef(null),j=s.useRef(!1),B=s.useRef(!1),ye=s.useRef(_),xe=s.useRef(null),U=s.useRef(!1),[ce,nt]=s.useState(null),[q,be]=s.useState(!0),[at,ke]=s.useState(null),[zr,qr]=s.useState([]),[we,ot]=s.useState([]),[We,st]=s.useState({}),[h,lt]=s.useState([]),[V,ve]=s.useState({}),[ee,fe]=s.useState(null),[Rt,Pe]=s.useState(!1),[it,Ne]=s.useState(null),[ct,Re]=s.useState({isOpen:!1,mediaId:null}),[Y,te]=s.useState(new Set),re=s.useRef(!1),[Ft,Lt]=s.useState(0),[Fe,Ae]=s.useState(!1),[Mt,ut]=s.useState(!1),[Hr,dt]=s.useState(!1),[Qr,Kr]=s.useState(!1),[Ot,Se]=s.useState(!1),[_t,pe]=s.useState(""),[Dt,Le]=s.useState(!1),[Be,mt]=s.useState({footnoteId:null,footnoteNumber:null,surah:null,ayah:null}),ne=Ar(),ae=Sr(),{pathname:ft}=ae,{user:he}=ir(),{toasts:Me,removeToast:Oe,showSuccess:ue,showError:J,showWarning:pt}=Er(),{quranFont:ht,translationLanguage:u,theme:Ut,fontSize:Vt,adjustedTranslationFontSize:gt,viewType:oe,setViewType:de}=cr(),zt=Math.max(Number(gt)-2,10),{surahId:d}=Br(),{getBlockViewCache:yt,setBlockViewCache:_e}=ur(),xt=s.useRef(!1),bt=s.useRef(u),kt=s.useRef(d),De=s.useRef(new Set);Fr({enabled:u==="E"&&oe==="Block Wise",context:"blockwise",dependencies:[V,h,d,ce]}),s.useEffect(()=>{ae.state?.viewType&&de(ae.state.viewType)},[ae.state,de]),s.useEffect(()=>{if(!(u==="mal"||u==="E")){oe!=="Ayah Wise"&&de("Ayah Wise");return}if(oe==="Ayah Wise"){const n=`/surah/${d}`;ft!==n&&ne(n)}else oe!=="Block Wise"&&de("Block Wise")},[oe,u,d,ne,ft,de]);const{surahs:Ue}=dr(u),Ee=s.useCallback((e=[])=>!Array.isArray(e)||e.length===0?new Set:new Set(e.map((n,t)=>{const o=n.AyaFrom??n.ayafrom??n.from??1,i=n.AyaTo??n.ayato??n.to??o,c=Number.parseInt(o,10),m=Number.parseInt(i,10),y=Number.isFinite(c)&&Number.isFinite(m),l=Number.isFinite(Number(o))?Number(o):1,k=y?c:l,w=Number.isFinite(Number(i))?Number(i):k,x=y?`${k}-${y?m:w}`:`${o}-${i}`;return n.ID||n.id||x||`block-${t}`})),[]),qt=e=>{const n=["Ù ","Ù¡","Ù¢","Ù£","Ù¤","Ù¥","Ù¦","Ù§","Ù¨","Ù©"];return e.toString().split("").map(t=>n[t]||t).join("")},Ht=e=>e?e.replace(/\s*ï´¿\s*[\d\u0660-\u0669]+\s*ï´¾\s*$/u,"").trim():"",Ve=(e,n)=>`${Ht(e)||e||""} ï´¿${qt(n)}ï´¾`,K=(e,n=null)=>{const t=Number.parseInt(e,10);return Number.isFinite(t)?t:n},ze=s.useCallback((e="manual")=>{if(!d)return;console.log(`[BlockWise] Triggering blockwise reload (${e})`),re.current=!1;const n=Ee(h);te(n),ve({}),ke(null),e==="manual"&&Ae(!1),Lt(t=>t+1)},[d,h,Ee]);s.useEffect(()=>(a.current||(a.current=new Audio,Ye.register(a.current)),()=>{a.current&&(a.current.pause(),a.current.src="",a.current.currentTime=0),D(null),X(null),M(null),L(!1),R(!1),$.current=null,j.current=!1}),[]);const Qt={"al-hudaify":"QH","al-afasy":"QA","al-ghamidi":"QG"},wt=e=>({E:"English",mal:"Malayalam",ur:"Urdu",bn:"Bangla",ta:"Tamil",hi:"Hindi"})[e]||e,Te=(e,n=!1,t=null)=>{if(!a.current)return;const o=t||n&&xe.current||ie;if(n||(xe.current=o),console.log("[BlockWise] playBlockAudio start",{blockId:e,fromContinuous:n,audioTypes:o,preservedAudioTypes:t,translationLanguage:u,selectedQirath:z}),!n&&u!=="mal"&&o.some(l=>l==="translation"||l==="interpretation")){const l=wt(u);pt(`${l} translation and explanation audio is coming soon. Currently, only Malayalam translation and explanation audio is available for blockwise view.`);const k=ie.filter(w=>w!=="translation"&&w!=="interpretation");k.length>0?Ie(k):Ie(["quran"]);return}if(a.current)try{a.current.pause(),a.current.onended=null,a.current.onerror=null,a.current.src="",a.current.load()}catch(y){console.warn("[BlockWise] Error cleaning up audio:",y)}const i=h.find(y=>(y.ID||y.id)===e);if(!i){console.error("Block not found:",e),B.current=!1;return}const c=i.AyaFrom||i.ayafrom||i.from||1,m=K(c,1);L(!0),D(e),M(m),F(1),R(!1),$.current=e,j.current=!0,console.log("[BlockWise] playBlockAudio state set",{playingBlock:e,normalizedStartingAyah:m,currentAudioType:o?.[0]||"quran",audioTypes:o}),window.dispatchEvent(new CustomEvent("audioStateChange",{detail:{isPlaying:!0}})),me(e,m,0,o)},Kt=async(e,n,t,o=1)=>{const i=String(e).padStart(3,"0"),c=String(n).padStart(3,"0"),m="https://thafheem.net/audio";if(t==="quran")return{primary:`${m}/qirath/${z}/${Qt[z]}${i}_${c}.ogg`,fallback:null};if(t==="translation"){const y=`${m}/translation/T${i}_${c}.ogg`;let l=null;if(u==="mal"&&n>1){const k=String(n-1).padStart(3,"0");l=`${m}/translation/T${i}_${k},${c}.ogg`}return{primary:y,fallback:l}}else if(t==="interpretation"){let y;if(o===1)y=`${m}/interpretation/I${i}_${c}.ogg`;else{const l=String(o).padStart(2,"0");y=`${m}/interpretation/I${i}_${c}_${l}.ogg`}return{primary:y,fallback:null}}return{primary:null,fallback:null}},H=async(e,n,t=0,o=null)=>{if(!a.current||Ye.getShouldStop())return;const i=K(n,K(P,1)||1),c=o||ie;if(console.log("[BlockWise] playAyahAudioWithTypes",{blockId:e,requestedAyah:n,ayahToPlay:i,audioTypeIndex:t,audioTypes:c,audioTypesLength:c.length,shouldMoveToNext:t>=c.length,playbackSpeed:_,isContinuousPlay:O,isPaused:G,playingBlock:E}),t>=c.length){console.log("[BlockWise] All audio types played for ayah, moving to next ayah",{audioTypeIndex:t,audioTypesLength:c.length,ayahToPlay:i,blockId:e}),vt(i,c);return}try{a.current.onended&&(a.current.onended=null),a.current.onerror&&(a.current.onerror=null),a.current.pause()}catch(S){console.warn("[BlockWise] Error stopping previous audio:",S)}const m=c[t];let y=1;m==="interpretation"&&(y=Pt);let l;try{l=await Kt(d,i,m,y)}catch(S){console.error("[BlockWise] Error generating audio URL:",S),H(e,i,t+1,o);return}if(!l||!l.primary){H(e,i,t+1,o);return}let k=l.primary;console.log("[BlockWise] generated audioUrl",{blockId:e,ayahToPlay:i,currentAudioType:m,primary:l.primary,fallback:l.fallback});const N={quran:"qirath",translation:"translation",interpretation:"interpretation"}[m]||"qirath";X(N),M(i);try{a.current.onended=null,a.current.onerror=null}catch(S){console.warn("[BlockWise] Error clearing audio handlers:",S)}let x=null;const A=()=>{x&&(clearTimeout(x),x=null)},b=(S,T=!1)=>{if(!a.current)return;T||(U.current=!1);try{a.current.onended=null,a.current.onerror=null}catch(f){console.warn("[BlockWise] Error clearing audio handlers:",f)}a.current.onended=()=>{if(A(),console.log("[BlockWise] Audio ended",{blockId:e,ayahToPlay:i,audioTypeIndex:t,currentAudioType:m,url:S,isFallback:T,playingBlock:$.current,isContinuousPlay:j.current,audioTypes:c,totalTypes:c.length,isProcessingNext:B.current}),B.current){console.warn("[BlockWise] onended handler aborted - already processing next move");return}j.current&&$.current===e?(console.log("[BlockWise] Continuing to next audio type/ayah"),H(e,i,t+1,c)):console.warn("[BlockWise] Not continuing - state mismatch",{isContinuousPlay:j.current,playingBlock:$.current,blockId:e,ayahToPlay:i})},a.current.onerror=f=>{A();const g=a.current;if(!T&&!U.current&&m==="translation"&&u==="mal"&&l.fallback){if(U.current=!0,console.log("[BlockWise] Primary Malayalam translation audio failed, trying fallback:",l.fallback),g)try{g.pause(),g.currentTime=0,g.src="",g.load()}catch(W){console.warn("[BlockWise] Error resetting audio for fallback:",W)}b(l.fallback,!0);return}if(!T&&U.current)return;if(T&&m==="translation"&&u==="mal"&&(console.log("[BlockWise] Fallback Malayalam translation audio also failed, moving to next audio type"),U.current=!1),g&&g.error){const W=g.error.code;if(W===2||W===4){if(m==="interpretation"){if(B.current=!0,a.current)try{a.current.pause(),a.current.onended=null,a.current.onerror=null}catch(Z){console.warn("[BlockWise] Error cleaning up audio on interpretation error:",Z)}if(F(1),j.current&&$.current===e){setTimeout(()=>{H(e,i,t+1,c),setTimeout(()=>{B.current=!1},300)},200);return}else B.current=!1}}else console.error("[BlockWise] Unexpected audio error:",{errorCode:g.error?.code,audioUrl:S,currentAudioType:m})}else console.error("[BlockWise] Audio error event (unknown error):",S,f);j.current&&$.current===e&&!B.current?setTimeout(()=>{H(e,i,t+1,c)},200):B.current||console.warn("[BlockWise] Not continuing after error - state mismatch",{isContinuousPlay:j.current,playingBlock:$.current,blockId:e})};const I=()=>{B.current=!1,a.current&&(a.current.playbackRate=ye.current),a.current.removeEventListener("canplay",I)};a.current.addEventListener("canplay",I,{once:!0}),a.current.addEventListener("canplay",A,{once:!0}),a.current.addEventListener("loadeddata",A,{once:!0});const v=()=>{a.current&&(a.current.playbackRate=ye.current),a.current.removeEventListener("loadedmetadata",v)};a.current.addEventListener("loadedmetadata",v,{once:!0});const p=()=>{A(),x=setTimeout(()=>{if(a.current&&a.current.readyState<2&&E===e&&P===i&&O){if(T&&m==="translation"&&u==="mal"){console.log("[BlockWise] Fallback audio still loading, extending timeout..."),A(),x=setTimeout(()=>{a.current&&a.current.readyState<2&&E===e&&P===i&&O&&(console.warn("[BlockWise] Fallback audio load timeout (file may be missing):",S),H(e,i,t+1,c))},5e3);return}if(console.warn("[BlockWise] Audio load timeout (file may be missing):",S),!T&&!U.current&&m==="translation"&&u==="mal"&&l.fallback){U.current=!0,console.log("[BlockWise] Primary audio timeout, trying fallback:",l.fallback),b(l.fallback,!0);return}if(!T&&U.current)return;H(e,i,t+1,c)}},5e3)};a.current.src=S,a.current.playbackRate=ye.current,a.current.load(),p(),a.current.play().catch(f=>{if(A(),!T&&!U.current&&m==="translation"&&u==="mal"&&l.fallback){if(U.current=!0,console.log("[BlockWise] Primary Malayalam translation audio play failed, trying fallback:",l.fallback),a.current)try{a.current.pause(),a.current.currentTime=0,a.current.src="",a.current.load()}catch(C){console.warn("[BlockWise] Error resetting audio for fallback:",C)}b(l.fallback,!0);return}if(!T&&U.current)return;if(B.current){setTimeout(()=>{B.current=!1},100);return}if(f.name==="AbortError"&&T){console.log("[BlockWise] AbortError during fallback (likely from reset), ignoring");return}f.name!=="NotSupportedError"&&f.name!=="AbortError"&&console.error("[BlockWise] Error playing audio:",f.name,f.message,S),j.current&&$.current===e?(B.current=!1,setTimeout(()=>{H(e,i,t+1,c)},200)):(B.current=!1,console.warn("[BlockWise] Not continuing after play error - state mismatch",{blockId:e,playingBlockRef:$.current,isContinuousPlayRef:j.current}))})};b(k,!1)},me=(e,n,t=0,o=null)=>{H(e,n,t,o)},vt=(e=null,n=null)=>{if(B.current){console.warn("[BlockWise] moveToNextAyahOrBlock aborted - already processing next",{currentAyahOverride:e,currentAyahInBlock:P});return}const t=e??P,o=$.current||E;if(!o||!t){console.warn("[BlockWise] moveToNextAyahOrBlock aborted - no playing block or ayah",{currentPlayingBlock:o,effectiveCurrentAyah:t,playingBlock:E,playingBlockRef:$.current});return}B.current=!0;const i=h.find(k=>(k.ID||k.id)===o);if(!i){B.current=!1;return}const c=i.AyaTo||i.ayato||i.to,m=K(t,null),y=K(c,m);if(m===null||y===null){console.warn("[BlockWise] moveToNextAyahOrBlock aborted - invalid ayah numbers",{currentPlayingBlock:o,currentAyahInBlock:t,ayaTo:c}),B.current=!1;return}const l=m+1;if(console.log("[BlockWise] moveToNextAyahOrBlock",{currentPlayingBlock:o,currentAyahNumber:m,nextAyah:l,ayaToNumber:y,isContinuousPlay:j.current}),l<=y)F(1),me(o,l,0,n);else if(j.current){if(a.current)try{a.current.pause(),a.current.onended=null,a.current.onerror=null}catch(k){console.warn("[BlockWise] Error cleaning up audio before next block:",k)}F(1),B.current=!1,setTimeout(()=>{Yt()},50)}else{if(a.current)try{a.current.pause(),a.current.onended=null,a.current.onerror=null}catch(k){console.warn("[BlockWise] Error stopping audio:",k)}D(null),X(null),M(null),F(1),R(!1),$.current=null,j.current=!1,B.current=!1,window.dispatchEvent(new CustomEvent("audioStateChange",{detail:{isPlaying:!1}}))}},Xt=(e=null,n=null)=>{const t=e??P;if(!E||!t)return;const o=h.find(l=>(l.ID||l.id)===E);if(!o)return;const i=o.AyaFrom||o.ayafrom||o.from||1,c=K(t,null),m=K(i,1);if(c===null||m===null){console.warn("[BlockWise] moveToPreviousAyahOrBlock aborted - invalid ayah numbers",{playingBlock:E,currentAyahInBlock:t,ayaFrom:i});return}const y=c-1;console.log("[BlockWise] moveToPreviousAyahOrBlock",{playingBlock:E,currentAyahNumber:c,previousAyah:y,ayaFromNumber:m,isContinuousPlay:O}),y>=m?(F(1),me(E,y,0,n)):O?(F(1),Gt()):(D(null),X(null),M(null),F(1),R(!1))},Gt=()=>{if(!O||!h||h.length===0)return;const e=h.findIndex(n=>(n.ID||n.id)===E);if(e>0){const n=h[e-1],t=n.ID||n.id,o=n.AyaTo||n.ayato||n.to||1,i=K(o,1);L(!0),D(t),M(i),F(1),R(!1),$.current=t,j.current=!0,me(t,i)}else{const n=h[0],t=n.ID||n.id,o=n.AyaFrom||n.ayafrom||n.from||1,i=K(o,1);D(t),M(i),F(1),me(t,i)}},Yt=()=>{if(B.current){console.warn("[BlockWise] playNextBlock aborted - already processing next");return}if(!j.current||!h||h.length===0){console.warn("[BlockWise] playNextBlock aborted - invalid state",{isContinuousPlay:j.current,isContinuousPlayState:O,blockRangesLength:h?.length}),B.current=!1;return}B.current=!0;const n=$.current||E,t=h.findIndex(o=>(o.ID||o.id)===n);if(console.log("[BlockWise] playNextBlock",{currentIndex:t,currentPlayingBlock:n,playingBlock:E,playingBlockRef:$.current,blockRangesLength:h.length}),t!==-1&&t<h.length-1){const o=h[t+1],i=o.ID||o.id;if(!i){console.error("[BlockWise] playNextBlock - next block has no ID",o);return}if(a.current)try{a.current.pause(),a.current.onended=null,a.current.onerror=null,a.current.src="",a.current.load()}catch(c){console.warn("[BlockWise] Error cleaning up audio before next block:",c)}setTimeout(()=>{try{const c=xe.current||ie;Te(i,!0,c)}catch(c){console.error("[BlockWise] Error playing next block:",c),D(null),X(null),M(null),F(1),L(!1),R(!1),B.current=!1,window.dispatchEvent(new CustomEvent("audioStateChange",{detail:{isPlaying:!1}}))}},100)}else{if(console.log("[BlockWise] playNextBlock - end of blocks reached"),a.current)try{a.current.pause(),a.current.onended=null,a.current.onerror=null}catch(o){console.warn("[BlockWise] Error stopping audio at end:",o)}D(null),X(null),M(null),F(1),L(!1),R(!1),$.current=null,j.current=!1,B.current=!1,window.dispatchEvent(new CustomEvent("audioStateChange",{detail:{isPlaying:!1}}))}},Nt=()=>{if(!h||h.length===0){J("No blocks available to play");return}if(u!=="mal"){const e=wt(u);pt(`${e} translation and explanation audio is coming soon. Currently, only Malayalam translation and explanation audio is available.`);return}try{if(O)a.current&&a.current.pause(),L(!1),R(!0),j.current=!1,window.dispatchEvent(new CustomEvent("audioStateChange",{detail:{isPlaying:!1}}));else if(E&&P)L(!0),R(!1),j.current=!0,a.current&&a.current.play().then(()=>{window.dispatchEvent(new CustomEvent("audioStateChange",{detail:{isPlaying:!0}}))}).catch(e=>{console.error("Error resuming audio:",e)});else{L(!0),R(!1),j.current=!0;const e=h[0].ID||h[0].id;Te(e)}}catch(e){console.error("Error in handlePlayAudio:",e),L(!1),D(null),M(null),window.dispatchEvent(new CustomEvent("audioStateChange",{detail:{isPlaying:!1}}))}},qe=s.useRef(null);qe.current=Nt,s.useEffect(()=>{const e=()=>{qe.current&&qe.current()};return window.addEventListener("playAudio",e),()=>{window.removeEventListener("playAudio",e)}},[]),s.useEffect(()=>{const e=O&&!G&&E!==null;window.dispatchEvent(new CustomEvent("audioStateChange",{detail:{isPlaying:e}}))},[O,G,E]),s.useEffect(()=>{const e=n=>{const{type:t,message:o}=n.detail;t==="success"?ue(o):t==="error"&&J(o)};return window.addEventListener("showToast",e),()=>{window.removeEventListener("showToast",e)}},[ue,J]);const Ce=()=>{a.current&&(a.current.pause(),a.current.currentTime=0,a.current.onended=null,a.current.onerror=null),L(!1),D(null),X(null),M(null),$.current=null,j.current=!1,B.current=!1,window.dispatchEvent(new CustomEvent("audioStateChange",{detail:{isPlaying:!1}})),F(1),R(!1)};s.useEffect(()=>{const e=()=>{Ye.stopAll(),Ce()};return window.addEventListener("languageChange",e),()=>{window.removeEventListener("languageChange",e)}},[]),s.useEffect(()=>()=>{try{Ce()}catch{}},[]),s.useEffect(()=>()=>{a.current&&(a.current.pause(),D(null),X(null),M(null),F(1),L(!1),R(!1),$.current=null,j.current=!1,B.current=!1)},[d]),s.useEffect(()=>{localStorage.setItem("reciter",z),window.dispatchEvent(new CustomEvent("reciterChange",{detail:{reciter:z}}))},[z]),s.useEffect(()=>{const e=n=>{const t=n.detail.reciter;t!==z&&tt(t)};return window.addEventListener("reciterChange",e),()=>{window.removeEventListener("reciterChange",e)}},[z]),s.useEffect(()=>{E&&P&&a.current&&O&&me(E,P,0)},[z,ie]),s.useEffect(()=>{ye.current=_},[_]),s.useEffect(()=>{localStorage.setItem("playbackSpeed",_.toString()),window.dispatchEvent(new CustomEvent("playbackSpeedChange",{detail:{playbackSpeed:_}}))},[_]),s.useEffect(()=>{const e=n=>{const t=n.detail.playbackSpeed;t!==_&&rt(t)};return window.addEventListener("playbackSpeedChange",e),()=>{window.removeEventListener("playbackSpeedChange",e)}},[_]),s.useEffect(()=>{a.current&&(a.current.playbackRate=_)},[_]),s.useEffect(()=>{xt.current=!1},[d,u]),s.useEffect(()=>{Ae(!1)},[d]),s.useEffect(()=>{if(!d||!(u==="mal"||u==="E"))return;const n=yt?.(d,u);if(n){xt.current=!0,nt(n.blockData||null),lt(n.blockRanges||[]),ot(n.arabicVerses||[]),ve(n.blockTranslations||{}),ke(null),te(new Set);const t=n.blockTranslations?Object.keys(n.blockTranslations).length:0,o=!!(n.__meta?.isComplete&&t>0);be(!o),re.current=o}},[d,u,yt]),s.useEffect(()=>((async()=>{if(!d||re.current||Ue.length===0)return;if(!(u==="mal"||u==="E")){console.log(`âš ï¸ BlockWise: Language '${u}' doesn't support blockwise. Skipping fetch.`),be(!1);return}re.current=!0;try{be(!0),ke(null);const[t,o]=await Promise.all([wr(parseInt(d),u||"mal"),vr(parseInt(d))]),i=Ue.find(c=>c.number===parseInt(d));if(nt({surahInfo:i||{number:parseInt(d),arabic:"Ø§Ù„Ù‚Ø±Ø¢Ù†",type:"Makki"}}),ot(o||[]),lt(t||[]),t&&t.length>0){const c=async(v,p)=>{const f=v.AyaFrom||v.ayafrom||v.from,g=v.AyaTo||v.ayato||v.to;if(f==null||g===void 0||g===null)return;const C=Number.parseInt(f,10),W=Number.parseInt(g,10),se=Number.isFinite(C)&&Number.isFinite(W),Z=se?`${C}-${W}`:`${f}-${g}`,le=v.ID||v.id||Z||`block-${p}`,sr=se?C:f,lr=se?W:g;if(!De.current.has(le)){De.current.add(le);try{te(Q=>new Set([...Q,le]));let ge;const Ke=u||"mal";ge=await Nr(parseInt(d),Z,Ke),ve(Q=>Q[le]?.data?Q:{...Q,[le]:{range:Z,ayaFrom:sr,ayaTo:lr,data:ge}}),te(Q=>{const Et=new Set(Q);return Et.delete(le),Et})}catch(ge){ge.message?.includes("timeout")||console.error(`âŒ BlockWise: Failed to load block ${Z}:`,ge.message),te(Ke=>{const Q=new Set(Ke);return Q.delete(le),Q})}}};let k=2,w=0;const N=[];let x=0;const A=async(v,p)=>new Promise(f=>{const g=async()=>{x++;try{await c(v,p),w++,w===3&&k<5&&(k=5,console.log("ðŸš€ Increased concurrent requests from 2 to 5 after 3 successful loads"))}catch{}finally{x--,N.length>0&&N.shift()(),f()}};x<k?g():N.push(g)}),b=v=>{const p=v.slice(0,3),f=v.slice(3);return{visibleBlocks:p,backgroundBlocks:f}},{visibleBlocks:S,backgroundBlocks:T}=b(t),I=S.map((v,p)=>c(v,p));T.forEach((v,p)=>{setTimeout(()=>{A(v,p+S.length)},50*Math.floor(p/k))}),Promise.allSettled(I).then(v=>{const p=v.filter(f=>f.status==="fulfilled").length})}}catch(t){let o=t.message;t.message?.includes("timeout")||t.message?.includes("Request timeout")?o="The server is taking longer than expected to respond. Please try again in a moment. If the problem persists, the English blockwise data may be temporarily unavailable.":t.message?.includes("Failed to fetch")||t.message?.includes("Network error")?o="Unable to connect to the server. Please check your internet connection and try again.":t.message?.includes("HTTP error")&&(o=`Server error: ${t.message}. Please try again later.`),ke(o),console.error("Error fetching block-wise data:",t),re.current=!1}finally{be(!1)}})(),()=>{re.current=!1}),[d,Ue,u,Ft]),s.useEffect(()=>{if(!d||!(u==="mal"||u==="E")||!_e||q||!Array.isArray(h)||h.length===0)return;const t=(V?Object.keys(V).length:0)>0&&(!Y||Y.size===0);_e(d,u,{blockData:ce,blockRanges:h,arabicVerses:we,blockTranslations:V,__meta:{isComplete:t}})},[d,u,ce,h,we,V,q,Y,_e]),s.useEffect(()=>{const e=u==="mal"||u==="E",n=Array.isArray(h)&&h.length>0,t=q||Y&&Y.size>0,o=V?Object.keys(V).length:0;!d||!e||!n||t||o>0||Fe||(Ae(!0),ze("auto"))},[d,u,h,V,q,Y,Fe,ze]),s.useEffect(()=>{const e=bt.current!==u,n=kt.current!==d;!e&&!n||(bt.current=u,kt.current=d,h.length>0?te(Ee(h)):te(new Set),ve({}),De.current.clear(),re.current=!1,fe(null),je(!1),Se(!1),pe(""),Le(!1),mt({footnoteId:null,footnoteNumber:null,surah:null,ayah:null}),Ae(!1))},[u,d,h,Ee]),s.useEffect(()=>{(async()=>{if(!he||!d){dt(!1);return}try{const n=await Xe.isFavorited(he.uid,d);dt(n)}catch(n){console.error("Error loading favorite status:",n)}})()},[he,d]),s.useEffect(()=>{if(u!=="E")return;const e=async n=>{const t=n.target.closest(".english-footnote-link");if(!t)return;if(oe==="Block Wise"){n.preventDefault(),n.stopPropagation();const N=t.getAttribute("data-footnote-id"),x=t.getAttribute("data-interpretation-id"),A=x&&/^\d+$/.test(x)?parseInt(x,10):null,S=t.getAttribute("data-interpretation-number")||t.getAttribute("data-footnote-number")||(t.textContent||"").trim(),T=S&&/^\d+$/.test(S)?parseInt(S,10):1,I=t.getAttribute("data-ayah"),v=I?parseInt(I,10):null;if(!S&&!N){console.warn("[BlockWise] âš ï¸ Missing displayed number and footnote ID");return}let p=null;if(v&&h.length>0){const f=h.find(g=>{const C=g.AyaFrom||g.ayafrom||g.from||0,W=g.AyaTo||g.ayato||g.to||C;return v>=C&&v<=W});if(f){const g=f.AyaFrom||f.ayafrom||f.from||1,C=f.AyaTo||f.ayato||f.to||g;p=`${g}-${C}`}else console.warn("[BlockWise] âš ï¸ Could not find block range for verse:",v,"available blocks:",h.map(g=>({from:g.AyaFrom||g.ayafrom||g.from,to:g.AyaTo||g.ayato||g.to})))}if(!p&&h.length>0){const f=h[0],g=f.AyaFrom||f.ayafrom||f.from||1,C=f.AyaTo||f.ayato||f.to||g;p=`${g}-${C}`}if(p){fe({range:p,interpretationNumber:T,footnoteId:N,interpretationId:A});return}else console.warn("[BlockWise] âš ï¸ Could not determine block range, falling back to footnote modal")}n.preventDefault(),n.stopPropagation();const o=t.getAttribute("data-footnote-id"),i=t.getAttribute("data-interpretation-id"),c=i&&/^\d+$/.test(i)?parseInt(i,10):null,m=t.getAttribute("data-footnote-number")||(t.textContent||"").trim(),y=t.getAttribute("data-interpretation-number")||t.getAttribute("data-footnote-number"),l=y&&/^\d+$/.test(y)?parseInt(y,10):null,k=t.getAttribute("data-ayah"),w=k?parseInt(k,10):null;mt({footnoteId:o,interpretationId:c,footnoteNumber:m||null,surah:d?parseInt(d,10):null,ayah:w}),pe("Loading..."),Le(!0),Se(!0);try{let N="";if(c)N=await Ze.getInterpretationById(c);else if(o)N=await Ze.getExplanation(parseInt(o,10));else if(l&&w)N=await Ze.getInterpretationByNumber(parseInt(d,10),w,l);else{pe("Explanation not available.");return}pe(N||"Explanation not available.")}catch(N){console.error("Error fetching English footnote explanation:",N),pe(`Error loading explanation: ${N.message||N}`)}finally{Le(!1)}};return document.addEventListener("click",e),()=>{document.removeEventListener("click",e)}},[u,d,oe,h]);const Jt=e=>{if(!e)return"";const n=document.createElement("div");return n.innerHTML=e,n.textContent||n.innerText||""},Zt=(e={})=>e?.TranslationText||e?.translationText||e?.translation_text||e?.text||"",er=(e={},n)=>{const t=e?.VerseNo??e?.Verse_Number??e?.verse_number??e?.VerseNumber??e?.ayah_number??e?.AyaId??e?.AyahId??n,o=Number.parseInt(t,10);return Number.isFinite(o)?o:n},tr=(e=[],n=null,t=1)=>{const o=e.length>0?e:n?[n]:[];return o.length===0?"":o.map((i,c)=>{const m=Zt(i);if(!m)return"";const y=Jt(m).trim();if(!y)return"";const l=er(i,t+c);return o.length>1?`${l}. ${y}`:y}).filter(Boolean).join(`

`)},He=(e,n)=>{if(!e)return"";let t=String(e);t=t.replace(/\n/g,"<br>"),t=t.replace(/\t/g," ");const o=u==="E"?"en":u==="hi"?"hi":"mal",i="cursor:pointer!important;background-color:transparent!important;color:rgb(41,169,199)!important;font-weight:600!important;text-decoration:none!important;border:none!important;display:inline!important;font-size:12px!important;vertical-align:super!important;line-height:1!important;position:relative!important;top:3px!important;z-index:10!important;transition:0.2s ease-in-out!important;",c=m=>`<sup class="interpretation-link" data-interpretation="${m}" data-range="${n}" data-lang="${o}" data-interpretation-number="${m}" data-interpretation-label="${m}" title="Click to view interpretation ${m}" aria-label="Interpretation ${m}" style="${i}">${m}</sup>`;if(u==="hi"){const m=/(\d{1,3}[aAbB])/g,y=[];let l;for(;(l=m.exec(t))!==null;){const k=l[1],w=k.match(/^(\d{1,3})/);if(!w)continue;const N=parseInt(w[1],10);if(!(N>=1&&N<=342))continue;const x=l.index,A=t.substring(0,x),b=A.lastIndexOf("<"),S=A.lastIndexOf(">");if(b>S)continue;const T=Math.max(0,x-200),I=t.substring(T,x),v=I.lastIndexOf("<sup"),p=I.lastIndexOf("</sup>");v>p||y.push({index:x,token:k,length:k.length})}for(let k=y.length-1;k>=0;k--){const{index:w,token:N,length:x}=y[k],A=t.substring(0,w),b=t.substring(w+x);t=A+c(N)+b}return t}if(u==="mal"||u==="E"){const m=/(\d{1,3}[aA]?)/g,y=[];let l;for(;(l=m.exec(t))!==null;){const k=l[1],w=k.match(/^(\d{1,3})/);if(!w)continue;const N=parseInt(w[1],10);if(!(N>=1&&N<=342))continue;const x=l.index,A=t.substring(0,x),b=A.lastIndexOf("<"),S=A.lastIndexOf(">");if(b>S)continue;const T=Math.max(0,x-200),I=t.substring(T,x),v=I.lastIndexOf("<sup"),p=I.lastIndexOf("</sup>");if(v>p)continue;const f=t.substring(0,x),g=t.substring(x+k.length),C=f.lastIndexOf("("),W=g.indexOf(")");C!==-1&&W!==-1&&f.substring(C+1).indexOf(")")===-1||y.push({index:x,token:k,length:k.length})}for(let k=y.length-1;k>=0;k--){const{index:w,token:N,length:x}=y[k],A=t.substring(0,w),b=t.substring(w+x);t=A+c(N)+b}return u==="mal"&&(t=$r(t)),t}return t};s.useEffect(()=>(Ct(e=>Re({isOpen:!0,mediaId:e}),()=>Re({isOpen:!1,mediaId:null})),()=>Ct(null,null)),[]),s.useEffect(()=>{const e=t=>{if(t.target.closest(".malayalam-media-link")){jr(t);return}let i=t.target.closest(".interpretation-link");if(!i&&u==="E"){const c=t.target.closest(".english-footnote-link");if(c){const y=c.getAttribute("data-interpretation-number")||c.getAttribute("data-footnote-number")||c.textContent?.trim()||"",l=y&&/^\d+$/.test(y)?parseInt(y,10):1,k=c.getAttribute("data-surah"),w=c.getAttribute("data-ayah");if(k===d&&w&&h.length>0){const N=parseInt(w,10),x=h.find(A=>{const b=A.AyaFrom||A.ayafrom||A.from||0,S=A.AyaTo||A.ayato||A.to||b;return N>=b&&N<=S});if(x){const A=x.AyaFrom||x.ayafrom||x.from||1,b=x.AyaTo||x.ayato||x.to||A,S=`${A}-${b}`,T=c.getAttribute("data-footnote-id");t.preventDefault(),t.stopPropagation(),fe({range:S,interpretationNumber:l,footnoteId:T});return}else console.warn("[BlockWise] âš ï¸ Could not find block range for verse:",N)}}}if(i){t.preventDefault(),t.stopPropagation();const c=i.getAttribute("data-interpretation"),m=i.getAttribute("data-range");i.getAttribute("data-lang"),c&&m?fe({range:m,interpretationNumber:c}):console.warn("[BlockWise] âš ï¸ Missing interpretation data:",{interpretationNumber:c,range:m})}},n=document.createElement("style");return n.textContent=`
      .interpretation-link {
        cursor: pointer !important;
      }
      .interpretation-link > a {
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        width: 100% !important;
        height: 100% !important;
        color: inherit !important;
        font-weight: inherit !important;
        text-decoration: none !important;
      }
      .interpretation-link:hover {
        color: #0891b2 !important;
      }
      .interpretation-link:active {
        color: #0e7490 !important;
      }
    `,document.head.appendChild(n),document.addEventListener("click",e,!0),()=>{document.removeEventListener("click",e,!0),document.head.removeChild(n)}},[]);const At=()=>{const e=parseInt(d)-1;e>=1&&ne(`/blockwise/${e}`)},St=()=>{const e=parseInt(d)+1;e<=114&&ne(`/blockwise/${e}`)};if(s.useEffect(()=>{const e=()=>{(window.scrollY||document.documentElement.scrollTop||document.body.scrollTop||0)>300?ut(!0):ut(!1)};return window.addEventListener("scroll",e,{passive:!0}),document.addEventListener("scroll",e,{passive:!0}),e(),()=>{window.removeEventListener("scroll",e),document.removeEventListener("scroll",e)}},[]),s.useEffect(()=>{const e=()=>{const n=ae.state?.scrollToBlock;n&&!q&&h.length>0&&setTimeout(()=>{const t=document.getElementById(`block-${n}`);t&&(t.scrollIntoView({behavior:"smooth",block:"center"}),t.style.backgroundColor="#fef3c7",setTimeout(()=>{t.style.backgroundColor=""},2e3))},500)};!q&&h.length>0&&e()},[q,h,ae.state]),q&&h.length===0)return r.jsxs(r.Fragment,{children:[r.jsx(Ge,{toasts:Me,removeToast:Oe}),r.jsx("div",{className:"min-h-screen bg-white dark:bg-gray-900 px-4 py-8",children:r.jsxs("div",{className:"max-w-7xl mx-auto",children:[r.jsxs("div",{className:"text-center mb-8",children:[r.jsx("div",{className:"h-12 bg-gradient-to-r from-gray-200 to-gray-300 dark:from-gray-700 dark:to-gray-600 rounded w-64 mx-auto mb-4 relative overflow-hidden",children:r.jsx("div",{className:"absolute inset-0 -translate-x-full animate-shimmer bg-gradient-to-r from-transparent via-white/60 dark:via-white/10 to-transparent"})}),r.jsx("div",{className:"h-6 bg-gradient-to-r from-gray-200 to-gray-300 dark:from-gray-700 dark:to-gray-600 rounded w-40 mx-auto relative overflow-hidden",children:r.jsx("div",{className:"absolute inset-0 -translate-x-full animate-shimmer bg-gradient-to-r from-transparent via-white/60 dark:via-white/10 to-transparent"})})]}),r.jsx($t,{count:3})]})})]});if(at)return r.jsxs(r.Fragment,{children:[r.jsx(Ge,{toasts:Me,removeToast:Oe}),r.jsx("div",{className:"min-h-screen bg-white dark:bg-black flex items-center justify-center",children:r.jsxs("div",{className:"text-center",children:[r.jsx("p",{className:"text-red-500 dark:text-red-400 text-lg mb-2",children:"Failed to load Block-wise data"}),r.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-4",children:at}),r.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-cyan-500 text-white rounded-lg hover:bg-cyan-600 transition-colors",children:"Try Again"})]})})]});const Qe=ce?.surahInfo?.arabic||(d?`Surah ${d}`:"Surah"),rr=Lr(d,Qe),Bt=d?String(d):"",nr=Bt==="1"||Bt==="2"?"font-normal":"font-semibold",ar=V?Object.keys(V).length:0,or=!q&&Array.isArray(h)&&h.length>0&&(Y?.size??0)===0&&ar===0&&Fe;return r.jsxs(r.Fragment,{children:[r.jsx(Ge,{toasts:Me,removeToast:Oe}),r.jsx("div",{className:"mx-auto min-h-screen bg-gray-50 dark:bg-gray-900 font-outfit transition-colors duration-300",children:r.jsxs("div",{className:"sticky top-0 z-40 glass border-b border-gray-200/50 dark:border-gray-700/50 transition-all duration-300",children:[r.jsx("div",{className:"container-responsive py-3 sm:py-4",children:r.jsxs("div",{className:"flex flex-col items-center justify-center relative",children:[r.jsx("div",{className:"mb-2 sm:mb-4",children:r.jsx("h1",{className:`text-4xl sm:text-5xl md:text-6xl font-arabic text-center text-gray-800 dark:text-white drop-shadow-sm ${nr}`,style:{fontFamily:Mr},"aria-label":Qe,children:ce?rr:Qe})}),parseInt(d)!==1&&parseInt(d)!==9&&r.jsx("div",{className:"mb-4 sm:mb-6",children:r.jsx("div",{className:"hidden sm:block",children:r.jsx("div",{className:"max-w-[1290px] mx-auto relative flex items-center justify-center px-4 lg:px-8",children:r.jsx("div",{className:"flex-shrink-0 px-4 sm:px-6 pt-8 pb-6 sm:pt-10 sm:pb-8",children:parseInt(d)!==1&&parseInt(d)!==9?r.jsx("img",{src:Ut==="dark"?Ir:Wr,alt:"Bismi",className:"w-[236px] h-[52.9px]"}):r.jsx("div",{className:"h-[52.9px]"})})})})}),r.jsx("div",{className:"w-full flex justify-center mb-4 sm:mb-6",children:(u==="mal"||u==="E")&&r.jsx(mr,{options:["Ayah Wise","Block Wise"],value:"Block Wise",onChange:e=>de(e)})}),or&&r.jsx("div",{className:"w-full flex justify-center mb-4",children:r.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2 rounded-2xl border border-amber-200 dark:border-amber-700 bg-amber-50 dark:bg-amber-900/30 px-4 py-3 text-sm text-amber-900 dark:text-amber-100",children:[r.jsx("span",{children:"We couldn't load the blockwise translation. Please retry."}),r.jsx("button",{type:"button",className:"inline-flex items-center justify-center rounded-full bg-amber-600 text-white px-3 py-1.5 text-xs font-semibold hover:bg-amber-700 transition-colors",onClick:()=>ze("manual"),children:"Retry now"})]})})]})}),r.jsx("div",{className:`container-responsive py-6 sm:py-8 space-y-4 sm:space-y-6 ${P?"pb-32 sm:pb-36":""}`,children:q&&h.length===0?r.jsx($t,{count:5}):h&&h.length>0?h.map((e,n)=>{const t=e.AyaFrom??e.ayafrom??e.from??1,o=e.AyaTo??e.ayato??e.to??t,i=Number.parseInt(t,10),c=Number.parseInt(o,10),m=Number.isFinite(i)&&Number.isFinite(c),y=Number.isFinite(Number(t))?Number(t):1,l=m?i:y,k=Number.isFinite(Number(o))?Number(o):l,w=m?c:k,N=m?`${l}-${w}`:`${t}-${o}`,x=e.ID||e.id||N||`block-${n}`,b=(V[x]||null)?.data,S=u==="mal"&&!Array.isArray(b)&&!Array.isArray(b?.translations)&&!Array.isArray(b?.data)&&(b?.AudioText||b?.translation_text||b?.TranslationText),T=Array.isArray(b)?b:Array.isArray(b?.translations)?b.translations:Array.isArray(b?.data)?b.data:[],I=b?tr(T,b,l):"",v=Array.isArray(we)?we.slice(l-1,w):[];return r.jsxs("div",{id:`block-${l}-${w}`,className:"relative rounded-2xl bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 hover:shadow-card hover:border-gray-200 dark:hover:border-gray-600 transition-all duration-300",children:[r.jsxs("div",{className:"absolute top-0 left-0 bg-gray-50 dark:bg-gray-700/50 px-3 py-1.5 border-b border-r border-gray-100 dark:border-gray-700 text-xs font-medium text-gray-500 dark:text-gray-400 z-10",style:{borderRadius:"16px 0"},children:[d,":",l,l!==w&&`-${w}`]}),r.jsxs("div",{className:"p-4 sm:p-6 lg:p-8 pt-12",children:[r.jsx("div",{className:"w-full mb-6 sm:mb-8 text-right",dir:"rtl",children:r.jsx("p",{className:"leading-[2.2] text-gray-800 dark:text-gray-100",style:{fontFamily:ht?`'${ht}', serif`:'"Amiri Quran", serif',direction:"rtl",lineHeight:"2.7",fontSize:`${Vt}px`},children:v.length>0?v.map((p,f)=>Ve(p.text_uthmani,l+f)).join(" "):"Loading Arabic text..."})}),r.jsx("div",{className:"w-full text-left mb-6",children:b?r.jsx("div",{className:`prose dark:prose-invert max-w-none text-gray-600 dark:text-gray-300 ${u==="hi"?"font-hindi":u==="ur"?"font-urdu":u==="bn"?"font-bengali":u==="ta"?"font-tamil":u==="mal"?"font-malayalam":"font-poppins"}`,style:{fontSize:`${gt}px`},children:S?r.jsx("div",{className:"leading-relaxed","data-footnote-context":"blockwise",dangerouslySetInnerHTML:{__html:He(b.AudioText||b.translation_text||b.TranslationText||"",`${l}-${w}`)}}):T.length>0?T.map((p,f)=>{const g=p.TranslationText||p.translationText||p.translation_text||p.text||"";p.VerseNo||p.Verse_Number||p.verse_number||p.VerseNumber||p.ayah_number||p.AyaId||p.AyahId||l+f;const C=He(g,`${l}-${w}`);return r.jsx("div",{className:"leading-relaxed","data-footnote-context":"blockwise",dangerouslySetInnerHTML:{__html:C}},`translation-${x}-${f}`)}):b?.TranslationText||b?.translationText||b?.translation_text||b?.text?r.jsx("div",{className:"leading-relaxed","data-footnote-context":"blockwise",dangerouslySetInnerHTML:{__html:He(b.TranslationText||b.translationText||b.translation_text||b.text,`${l}-${w}`)}}):r.jsx("p",{children:"Translation not available"})}):Y.has(x)?r.jsx(Pr,{message:"Loading translation..."}):r.jsx("p",{className:"text-gray-500 dark:text-gray-400 text-sm",children:"Translation not available"})}),r.jsx("div",{className:"flex items-center justify-between pt-4 border-t border-gray-100 dark:border-gray-700/50",children:r.jsxs("div",{className:"flex items-center gap-1 sm:gap-2",children:[r.jsx("button",{className:"icon-btn",onClick:async()=>{try{const g=`${v.length>0?v.map((C,W)=>Ve(C.text_uthmani,l+W)).join(" "):"Loading Arabic text..."}

${I||"Translation not available"}`;await navigator.clipboard.writeText(g),ue("Text copied to clipboard!")}catch(p){console.error("Copy failed",p),J("Failed to copy text")}},title:"Copy text",children:r.jsx(fr,{className:"w-5 h-5"})}),r.jsx("button",{className:`icon-btn ${E===x&&!G?"text-primary bg-primary/10":""}`,onClick:()=>{E===x?G?(R(!1),L(!0),j.current=!0,a.current&&a.current.play().then(()=>{window.dispatchEvent(new CustomEvent("audioStateChange",{detail:{isPlaying:!0}}))}).catch(p=>{console.error("Error resuming audio:",p)})):(a.current&&a.current.pause(),R(!0),L(!1),window.dispatchEvent(new CustomEvent("audioStateChange",{detail:{isPlaying:!1}}))):Te(x)},title:E===x?G?"Resume audio":"Pause audio":"Play audio",children:E===x&&!G?r.jsx(pr,{className:"w-5 h-5"}):r.jsx(hr,{className:"w-5 h-5"})}),u!=="ta"&&u!=="E"&&u!=="mal"&&r.jsx("button",{className:"icon-btn group",onClick:p=>{const f=`/surah/${d}#verse-${l}`;p?.ctrlKey||p?.metaKey?(p.preventDefault(),window.open(f,"_blank","noopener,noreferrer")):ne(f)},title:"View ayah details",children:r.jsx(gr,{className:"w-5 h-5 group-hover:scale-110 transition-transform"})}),r.jsx("button",{className:"icon-btn group",onClick:p=>{const f=`/word-by-word/${d}/${l}`;if(p?.ctrlKey||p?.metaKey){p.preventDefault(),window.open(f,"_blank","noopener,noreferrer");return}Pe(!0),Ne(l)},title:"Word by word",children:r.jsx(yr,{className:"w-5 h-5 group-hover:scale-110 transition-transform"})}),r.jsx("button",{className:`icon-btn ${We[`${l}-${w}`]?"opacity-50 cursor-not-allowed":""}`,onClick:async()=>{if(!he){J("Please sign in to bookmark blocks"),ne("/sign",{state:{from:ae.pathname,message:"Sign in to bookmark blocks"}});return}const p=`${l}-${w}`;try{st(g=>({...g,[p]:!0}));const f=Xe.getEffectiveUserId(he);await Xe.addBlockBookmark(f,d,l,w),ue(`Saved block ${l}-${w}`)}catch(f){console.error("Failed to bookmark block:",f),J("Failed to save block")}finally{st(f=>({...f,[p]:!1}))}},title:"Bookmark block",disabled:We[`${l}-${w}`],children:We[`${l}-${w}`]?r.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b border-current"}):r.jsx(xr,{className:"w-5 h-5"})}),r.jsx("button",{className:"icon-btn",onClick:async()=>{try{const p=window.location.href,C=`${v.length>0?v.map((se,Z)=>Ve(se.text_uthmani,l+Z)).join(" "):"Arabic text is loading..."}

${I||"Translation not available"}

Read more: ${p}`,W=`Surah ${d} â€¢ Verses ${l}-${w}`;navigator.share?await navigator.share({title:W,text:C}):(await navigator.clipboard.writeText(C),ue("Content copied to clipboard!"))}catch(p){console.error("Share failed",p),J("Failed to share")}},title:"Share block",children:r.jsx(br,{className:"w-5 h-5"})})]})})]})]},`block-${x}-${l}-${w}`)}):r.jsx("div",{className:"text-center py-8",children:r.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"No blocks available for this Surah"})})}),r.jsx("div",{className:"bg-gray-50 dark:bg-gray-900 dark:border-gray-700 px-3 sm:px-4 lg:px-6 py-3 sm:py-4 mt-6 sm:mt-8",children:r.jsxs("div",{className:"max-w-4xl mx-auto",children:[r.jsxs("div",{className:"sm:hidden space-y-2",children:[r.jsxs("div",{className:"flex space-x-2",children:[r.jsxs("button",{onClick:At,disabled:parseInt(d)<=1,className:`flex-1 flex items-center justify-center space-x-2 px-4 py-2 text-xs text-gray-600 \r
                               dark:bg-[#323A3F] dark:text-white hover:text-gray-900 dark:hover:text-gray-300 \r
                               border border-gray-300 dark:border-gray-600 rounded-lg w-[173.96px] min-h-[44px]\r
                               disabled:opacity-50 disabled:cursor-not-allowed`,children:[r.jsx(It,{className:"w-3 h-3"}),r.jsx("span",{children:"Previous Surah"})]}),r.jsxs("button",{onClick:()=>window.scrollTo({top:0,behavior:"smooth"}),className:`flex-1 flex items-center justify-center space-x-2 px-4 py-2 text-xs text-gray-600 \r
                               dark:bg-[#323A3F] dark:text-white hover:text-gray-900 dark:hover:text-gray-300 \r
                               border border-gray-300 dark:border-gray-600 rounded-lg min-h-[44px]`,children:[r.jsx(Je,{className:"w-3 h-3"}),r.jsx("span",{children:"Beginning of Surah"})]})]}),r.jsx("div",{className:"flex justify-center",children:r.jsxs("button",{onClick:St,disabled:parseInt(d)>=114,className:`w-[173.96px] flex items-center justify-center space-x-2 px-4 py-2 text-xs text-gray-600 \r
                                 dark:bg-[#323A3F] dark:text-white hover:text-gray-900 dark:hover:text-gray-300 \r
                                 border border-gray-300 dark:border-gray-600 rounded-lg min-h-[44px]\r
                                 disabled:opacity-50 disabled:cursor-not-allowed`,children:[r.jsx("span",{children:"Next Surah"}),r.jsx(Tt,{className:"w-3 h-3"})]})})]}),r.jsxs("div",{className:"hidden sm:flex items-center justify-center space-x-2 sm:space-x-4 lg:space-x-6",children:[r.jsxs("button",{onClick:At,disabled:parseInt(d)<=1,className:"flex items-center space-x-2 px-3 sm:px-4 py-2 text-xs sm:text-sm bg-white border border-gray-300 rounded-full shadow-sm text-gray-600 dark:bg-[#323A3F] dark:text-white hover:text-gray-900 dark:hover:text-gray-300 transition-colors min-h-[44px] sm:min-h-[48px] disabled:opacity-50 disabled:cursor-not-allowed",children:[r.jsx(It,{className:"w-3 h-3 sm:w-4 sm:h-4"}),r.jsx("span",{children:"Previous Surah"})]}),r.jsxs("button",{onClick:()=>window.scrollTo({top:0,behavior:"smooth"}),className:"flex items-center space-x-2 px-3 sm:px-4 py-2 text-xs sm:text-sm bg-white border border-gray-300 rounded-full shadow-sm text-gray-600 dark:bg-[#323A3F] dark:text-white hover:text-gray-900 dark:hover:text-gray-300 transition-colors min-h-[44px] sm:min-h-[48px]",children:[r.jsx(Je,{className:"w-3 h-3 sm:w-4 sm:h-4"}),r.jsx("span",{children:"Beginning of Surah"})]}),r.jsxs("button",{onClick:St,disabled:parseInt(d)>=114,className:"flex items-center space-x-2 px-3 sm:px-4 py-2 text-xs sm:text-sm bg-white border border-gray-300 rounded-full shadow-sm text-gray-600 dark:bg-[#323A3F] dark:text-white hover:text-gray-900 dark:hover:text-gray-300 transition-colors min-h-[44px] sm:min-h-[48px] disabled:opacity-50 disabled:cursor-not-allowed",children:[r.jsx("span",{children:"Next Surah"}),r.jsx(Tt,{className:"w-3 h-3 sm:w-4 sm:h-4"})]})]})]})}),Wt&&$e&&r.jsxs("div",{className:"fixed inset-0 z-[99999] flex items-end sm:items-center justify-center",children:[r.jsx("div",{className:"fixed inset-0 bg-gray-900/50 backdrop-blur-sm transition-opacity",onClick:()=>{je(!1),et(null)}}),r.jsxs("div",{className:"relative w-full sm:w-[550px] max-h-[85vh] sm:max-h-[90vh] bg-white dark:bg-gray-900 rounded-t-2xl sm:rounded-2xl shadow-2xl flex flex-col animate-slideUp sm:animate-fadeIn overflow-hidden",children:[r.jsx("div",{className:"w-full flex justify-center pt-3 pb-1 sm:hidden cursor-grab active:cursor-grabbing",children:r.jsx("div",{className:"w-12 h-1.5 bg-gray-300 dark:bg-gray-600 rounded-full"})}),r.jsx("div",{className:"flex-1 overflow-y-auto",children:r.jsx(jt,{surahId:parseInt(d),range:$e.toString(),ipt:1,lang:u==="E"?"E":"mal",onClose:()=>{je(!1),et(null)},showSuccess:ue,showError:J,isModal:!0},`interpretation-${d}-${$e}`)})]})]}),Rt&&it&&r.jsx(Tr,{selectedVerse:it,surahId:d,onClose:()=>{Pe(!1),Ne(null)},onNavigate:e=>Ne(e),onSurahChange:e=>{Pe(!1),Ne(null),ne(`/surah/${e}?wordByWord=1`)}}),Ot&&r.jsxs("div",{className:"fixed inset-0 z-[99999] flex items-end sm:items-center justify-center",children:[r.jsx("div",{className:"fixed inset-0 bg-gray-900/50 backdrop-blur-sm transition-opacity",onClick:()=>Se(!1)}),r.jsxs("div",{className:"relative w-full sm:w-[480px] md:max-w-2xl lg:max-w-4xl xl:max-w-[1073px] max-h-[85vh] sm:max-h-[90vh] bg-white dark:bg-gray-900 rounded-t-2xl sm:rounded-2xl shadow-2xl flex flex-col animate-slideUp sm:animate-fadeIn overflow-hidden",children:[r.jsx("div",{className:"w-full flex justify-center pt-3 pb-1 sm:hidden cursor-grab active:cursor-grabbing",children:r.jsx("div",{className:"w-12 h-1.5 bg-gray-300 dark:bg-gray-600 rounded-full"})}),r.jsxs("div",{className:"flex items-center justify-between px-5 py-4 border-b border-gray-100 dark:border-gray-800",children:[r.jsxs("div",{children:[r.jsx("h2",{className:"text-xl font-semibold text-gray-800 dark:text-white",children:"English Explanation"}),Be?.footnoteNumber&&r.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:["Footnote ",Be.footnoteNumber,Be?.ayah?` â€¢ Ayah ${Be.ayah}`:""]})]}),r.jsx("button",{onClick:()=>Se(!1),className:"p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors text-gray-500 dark:text-gray-400",children:r.jsx(kr,{className:"w-5 h-5"})})]}),r.jsx("div",{className:"flex-1 overflow-y-auto p-5 space-y-6",children:Dt?r.jsx("div",{className:"flex items-center justify-center py-8",children:r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-500 mx-auto mb-4"}),r.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Loading explanation..."})]})}):r.jsx("div",{className:"bg-gray-50 dark:bg-gray-900 rounded-lg",children:r.jsx("div",{className:"text-gray-700 leading-[1.6] font-poppins sm:leading-[1.7] lg:leading-[1.8] dark:text-white text-sm sm:text-base lg:text-lg prose prose-sm dark:prose-invert max-w-none",style:{fontSize:`${zt}px`},children:_t})})})]})]}),ee&&r.jsx(jt,{surahId:parseInt(d),range:ee.range,ipt:ee.interpretationNumber,lang:u==="E"?"E":"mal",footnoteId:ee.footnoteId||null,blockRanges:h,onClose:()=>fe(null)},`block-interpretation-${d}-${ee.range}-${ee.interpretationNumber}-${ee.footnoteId||""}`)]})}),Mt&&r.jsx("button",{onClick:()=>window.scrollTo({top:0,behavior:"smooth"}),className:`fixed right-6 z-[100] bg-cyan-500 hover:bg-cyan-600 dark:bg-cyan-600 dark:hover:bg-cyan-700 text-white rounded-full p-3 shadow-lg transition-all duration-300 hover:scale-110 flex items-center justify-center ${P?"bottom-32 sm:bottom-36":"bottom-6"}`,title:"Beginning of Surah","aria-label":"Beginning of Surah",children:r.jsx(Je,{className:"w-6 h-6"})}),P&&r.jsx(Rr,{audioElement:a.current,isPlaying:O&&a.current&&!a.current.paused,currentAyah:P,totalAyahs:h.reduce((e,n)=>{const t=n.AyaTo||n.ayato||n.to||0,o=n.AyaFrom||n.ayafrom||n.from||0;return e+(t-o+1)},0),surahInfo:ce?.surahInfo,onPlayPause:Nt,onStop:Ce,onSkipBack:()=>{Xt()},onSkipForward:()=>{vt()},onClose:null,selectedQari:z,onQariChange:e=>{tt(e),E&&P&&(Ce(),setTimeout(()=>{Te(E)},100))},translationLanguage:u,audioTypes:ie,onAudioTypesChange:e=>{const n=E,t=P;if(console.log("[BlockWise] onAudioTypesChange",{newTypes:e,currentBlock:n,currentAyah:t,isContinuousPlay:O,isPaused:G}),Ie(e),xe.current=e,n&&t){if(a.current)try{a.current.pause(),a.current.currentTime=0}catch(o){console.warn("[BlockWise] Failed to pause audio before restarting with new types",o)}L(!0),R(!1),D(n),M(t),$.current=n,j.current=!0,setTimeout(()=>{console.log("[BlockWise] restarting playback after audioTypes change",{currentBlock:n,currentAyah:t,newTypes:e}),H(n,t,0,e)},100)}},playbackSpeed:_,onPlaybackSpeedChange:e=>{rt(e),a.current&&(a.current.playbackRate=e)}}),r.jsx(Cr,{isOpen:ct.isOpen,onClose:()=>Re({isOpen:!1,mediaId:null}),mediaId:ct.mediaId})]})};export{wn as default};
