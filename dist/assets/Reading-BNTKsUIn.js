const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/StickyAudioPlayer-Cxr1kIJb.js","assets/index-D0NMIq43.js","assets/react-vendor-v5ei6ytj.js","assets/index-DCU7il22.css","assets/volume-x-C8BF0xN2.js","assets/skip-forward-BY6SBxtt.js"])))=>i.map(i=>d[i]);
import{n as Ve,a as Te,u as ge,j as r,r as me,v as Ue,f as Me,o as fe,x as qe,_ as De,i as Qe,k as ze}from"./index-D0NMIq43.js";import{d as He,b as s,u as We}from"./react-vendor-v5ei6ytj.js";import{D as Oe,B as Ye,V as Ze,C as Je,A as Z,a as V}from"./LoadingSkeleton-BaxG_oO1.js";import{u as Ke,T as Xe}from"./Toast-Bf4bwsOE.js";import{g as Ge,s as et}from"./surahNameUtils-BTvJ0ckf.js";import{C as pe}from"./chevron-left-B6PCEYk2.js";const tt=s.lazy(()=>De(()=>import("./StickyAudioPlayer-Cxr1kIJb.js"),__vite__mapDeps([0,1,2,3,4,5]))),rt={"al-afasy":"QA","al-ghamidi":"QG","al-hudaify":"QH"},mt=()=>{const{surahId:o}=He();s.useEffect(()=>{o&&Ve({surahId:o,viewType:"reading",path:`/reading/${o}`})},[o]);const J=We(),{user:M}=Te(),{toasts:xe,removeToast:ye,showSuccess:K,showError:X}=Ke(),[m,q]=s.useState([]),[$,be]=s.useState(null),[G,D]=s.useState(!0),[ve,_]=s.useState(!1),[Q,z]=s.useState(null),[ee,we]=s.useState([]),[at,H]=s.useState(0),te=50,[w,re]=s.useState(()=>localStorage.getItem("reciter")||"al-afasy"),[W,Se]=s.useState(["quran"]),[x,ae]=s.useState(()=>{const e=localStorage.getItem("playbackSpeed");return e?parseFloat(e):1}),[ke,T]=s.useState(0),[F,u]=s.useState(!1),[N,A]=s.useState(null),[l,B]=s.useState(null),[S,U]=s.useState(0),f=s.useRef(null),j=s.useRef(null),[Ee,se]=s.useState(!1),[st,ne]=s.useState(!1),[nt,lt]=s.useState(!1),{translationLanguage:C}=ge(),je=async(e,t,a,c,h)=>{const p=String(e).padStart(3,"0"),i=String(t).padStart(3,"0");if(a==="quran")return{primary:`https://thafheem.net/audio/qirath/${c}/${h}${p}_${i}.ogg`,fallback:null};if(a==="translation"){if(C==="ur"){const k=await Qe(e,t);return k?{primary:k,fallback:null}:{primary:null,fallback:null}}const b=`https://thafheem.net/audio/translation/T${p}_${i}.ogg`;let d=null;if(C==="mal"&&t>1){const k=String(t-1).padStart(3,"0");d=`https://thafheem.net/audio/translation/T${p}_${k},${i}.ogg`}return{primary:b,fallback:d}}else if(a==="interpretation"){if(C==="ur"){const b=await ze(e,t);return b?{primary:b,fallback:null}:{primary:null,fallback:null}}return{primary:`https://thafheem.net/audio/interpretation/I${p}_${i}.ogg`,fallback:null}}return{primary:null,fallback:null}},y=async(e,t=0,a=null)=>{const c=a||W;if(e>=m.length){u(!1),A(null),U(0),T(0),B(null),window.dispatchEvent(new CustomEvent("audioStateChange",{detail:{isPlaying:!1}}));return}if(t>=c.length){y(e+1,0,a);return}l&&(l.pause(),l.currentTime=0,l.onended=null,l.onerror=null);const h=parseInt(o)||2,p=rt[w];m[e];const i=e+1,b=c[t];if(V.getShouldStop())return;let d;try{d=await je(h,i,b,w,p)}catch(g){console.error("[Reading] Error generating audio URL:",g),t<c.length-1?y(e,t+1,a):e<m.length-1?y(e+1,0,a):(u(!1),A(null));return}if(V.getShouldStop())return;if(!d||!d.primary){t<c.length-1?y(e,t+1,a):e<m.length-1?y(e+1,0,a):(u(!1),A(null));return}let k=d.primary,v=!1;const L=(g,E=!1)=>{if(V.getShouldStop())return null;E||(v=!1);const n=new Audio(g);V.register(n),n.preload="none",n.playbackRate=x;const ue=()=>{n&&f.current===n&&(n.playbackRate=x),n.removeEventListener("loadedmetadata",ue)};n.addEventListener("loadedmetadata",ue,{once:!0});const he=()=>{n&&f.current===n&&(n.playbackRate=x),n.removeEventListener("canplay",he)};n.addEventListener("canplay",he,{once:!0}),B(n),f.current=n,A(i),U(e),T(t),n.onended=()=>{f.current===n&&y(e,t+1,a)},n.onerror=P=>{if(console.error("Audio playback error:",P),console.error("Failed URL:",g),!E&&!v&&b==="translation"&&C==="mal"&&d.fallback){v=!0,console.log("[Reading] Primary Malayalam translation audio failed, trying fallback:",d.fallback),L(d.fallback,!0);return}!E&&v||f.current===n&&y(e,t+1,a)},n.play().then(()=>{window.dispatchEvent(new CustomEvent("audioStateChange",{detail:{isPlaying:!0}}))}).catch(P=>{if(P.name!=="AbortError"){if(!E&&!v&&b==="translation"&&C==="mal"&&d.fallback){v=!0,console.log("[Reading] Primary Malayalam translation audio play failed, trying fallback:",d.fallback),L(d.fallback,!0);return}if(!(!E&&v)){if(console.error("Error playing audio:",P),console.error("Audio URL that failed:",g),P.name==="NotSupportedError"||P.message.includes("CORS")){console.error("CORS error - audio server does not allow cross-origin requests"),setTimeout(()=>{y(e,t+1,a)},1e3);return}y(e,t+1,a)}}})};L(k,!1)},R=(e,t=0)=>{y(e,t,null)},I=()=>{l&&(l.pause(),l.currentTime=0),u(!1),A(null),U(0),T(0),B(null),f.current=null,window.dispatchEvent(new CustomEvent("audioStateChange",{detail:{isPlaying:!1}}))},Ne=e=>{const t=parseInt(e)-1;t>=0&&t<m.length?(l&&(l.pause(),l.currentTime=0,l.onended=null,l.onerror=null),B(null),f.current=null,setTimeout(()=>{A(parseInt(e)),U(t),T(0),u(!0),R(t,0)},100)):(console.error(`Invalid ayah index: ${t} for verse number ${e}`),console.error(`Valid range: 1 to ${m.length}`))},le=()=>{try{F?(l&&l.pause(),u(!1),window.dispatchEvent(new CustomEvent("audioStateChange",{detail:{isPlaying:!1}}))):(S>0||N?(u(!0),R(S,ke)):(u(!0),R(0,0)),window.dispatchEvent(new CustomEvent("audioStateChange",{detail:{isPlaying:!0}})))}catch(e){console.error("Error playing audio:",e),u(!1),A(null),B(null),window.dispatchEvent(new CustomEvent("audioStateChange",{detail:{isPlaying:!1}}))}},O=s.useRef(null);O.current=le,s.useEffect(()=>{const e=()=>{O.current&&O.current()};return window.addEventListener("playAudio",e),()=>{window.removeEventListener("playAudio",e)}},[]),s.useEffect(()=>{window.dispatchEvent(new CustomEvent("audioStateChange",{detail:{isPlaying:F}}))},[F]),s.useEffect(()=>{const e=t=>{const{type:a,message:c}=t.detail;a==="success"?K(c):a==="error"&&X(c)};return window.addEventListener("showToast",e),()=>{window.removeEventListener("showToast",e)}},[K,X]),s.useEffect(()=>{localStorage.setItem("reciter",w),window.dispatchEvent(new CustomEvent("reciterChange",{detail:{reciter:w}}))},[w]),s.useEffect(()=>{const e=t=>{const a=t.detail.reciter;a!==w&&re(a)};return window.addEventListener("reciterChange",e),()=>{window.removeEventListener("reciterChange",e)}},[w]),s.useEffect(()=>{F&&l&&I()},[w,W]),s.useEffect(()=>{localStorage.setItem("playbackSpeed",x.toString()),window.dispatchEvent(new CustomEvent("playbackSpeedChange",{detail:{playbackSpeed:x}}))},[x]),s.useEffect(()=>{const e=t=>{const a=t.detail.playbackSpeed;a!==x&&ae(a)};return window.addEventListener("playbackSpeedChange",e),()=>{window.removeEventListener("playbackSpeedChange",e)}},[x]),s.useEffect(()=>{l&&(l.playbackRate=x)},[l,x]),s.useEffect(()=>()=>{j.current&&(j.current.pause(),j.current.src="",j.current.currentTime=0,j.current.onended=null,j.current.onerror=null,j.current=null),f.current&&(f.current.pause(),f.current.src="",f.current.currentTime=0,f.current=null)},[]),s.useEffect(()=>{j.current=l},[l]),s.useEffect(()=>()=>{l&&I()},[o]),s.useEffect(()=>{const e=()=>{V.stopAll(),I()};return window.addEventListener("languageChange",e),()=>{window.removeEventListener("languageChange",e)}},[]),s.useEffect(()=>{(async()=>{try{D(!0),z(null),q([]),H(0);const t=o||2,[a,c]=await Promise.all([Ue(),Me()]),h=c.filter(i=>i.SuraId===parseInt(t)),p=a.find(i=>i.number===parseInt(t));be(p),we(h),D(!1),_(!0);try{const i=await fe(t,{page:1,limit:te}),b=Array.isArray(i?.verses)?i.verses:Array.isArray(i)?i:[];q(b),H(b.length);const d=i?.pagination||null;if(d?.hasNext){const k=async()=>{let v=(d.page||1)+1,L=d.hasNext;for(;L;)try{const g=await fe(t,{page:v,limit:te}),E=Array.isArray(g?.verses)?g.verses:Array.isArray(g)?g:[];E.length>0&&(q(n=>[...n,...E]),H(n=>n+E.length)),L=g?.pagination?.hasNext,v+=1}catch(g){console.error("Error loading additional verses:",g);break}_(!1)};window.requestIdleCallback?window.requestIdleCallback(k,{timeout:1e3}):setTimeout(k,100)}else _(!1)}catch(i){console.error("Error loading verses:",i),z(i.message),_(!1)}}catch(t){console.error("Error fetching surah data:",t),z(t.message),D(!1),_(!1)}})()},[o]),s.useEffect(()=>{(async()=>{if(!M||!o){ne(!1);return}try{const t=await qe.isFavorited(M.uid,o);ne(t)}catch(t){console.error("Error loading favorite status:",t)}})()},[M,o]);const Ae=e=>{const t=ee.find(a=>e>=a.ayafrom&&e<=a.ayato);return t?t.PageId:null},Ce=()=>{const e=[];let t=null,a=[];return m.forEach((c,h)=>{const p=c.verse_number||h+1,i=Ae(p);i!==t?(a.length>0&&e.push({pageNumber:t,verses:a,startVerse:a[0].verse_number,endVerse:a[a.length-1].verse_number}),t=i,a=[{...c,verse_number:p}]):a.push({...c,verse_number:p})}),a.length>0&&e.push({pageNumber:t,verses:a,startVerse:a[0].verse_number,endVerse:a[a.length-1].verse_number}),e},ie=()=>{const t=(parseInt(o)||2)-1;t>=1&&J(`/reading/${t}`)},oe=()=>{const t=(parseInt(o)||2)+1;t<=114&&J(`/reading/${t}`)},Y=()=>{window.scrollTo({top:0,behavior:"smooth"})};s.useEffect(()=>{const e=()=>{window.scrollY>300?se(!0):se(!1)};return window.addEventListener("scroll",e),()=>window.removeEventListener("scroll",e)},[]);const Re=e=>{const t=["٠","١","٢","٣","٤","٥","٦","٧","٨","٩"];return e.replace(/\d/g,a=>t[a])},Ie=e=>e?e.replace(/\s*﴿\s*[\d\u0660-\u0669]+\s*﴾\s*$/u,"").trim():"",{quranFont:Le,theme:Pe,fontSize:$e}=ge(),_e=s.useMemo(()=>Ce(),[m,ee]),ce=$?.arabic||(o?`Surah ${o}`:"Surah"),Fe=Ge(o,ce),de=o?String(o):"",Be=de==="1"||de==="2"?"font-normal":"font-semibold";return r.jsxs(r.Fragment,{children:[r.jsx(Xe,{toasts:xe,removeToast:ye}),r.jsxs("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900",children:[r.jsx("div",{className:"px-3 sm:px-4 lg:px-6 pt-6 sm:pt-8 pb-2 dark:bg-gray-900",children:r.jsx("div",{className:"max-w-4xl mx-auto text-center",children:r.jsxs("div",{className:"mb-4 sm:mb-5",children:[r.jsx("h1",{className:`text-4xl sm:text-5xl font-arabic dark:text-white text-gray-900 mb-6 sm:mb-8 ${Be}`,style:{fontFamily:et},"aria-label":ce,children:Fe}),$?.number!==1&&$?.number!==9&&r.jsx("div",{className:"mb-3 sm:mb-4",children:r.jsx("p",{className:"text-xl sm:text-2xl md:text-3xl lg:text-4xl font-arabic dark:text-white text-gray-800 leading-relaxed px-2",children:r.jsx("img",{src:Pe==="dark"?Oe:Ye,alt:"Bismillah",className:"w-auto h-8 sm:h-10 lg:h-12 xl:h-14 mx-auto"})})})]})})}),r.jsxs("div",{className:"max-w-xs sm:max-w-2xl lg:max-w-4xl mx-auto px-3 sm:px-4 py-4 sm:py-6",children:[G&&r.jsx(Ze,{count:5}),Q&&r.jsxs("div",{className:"text-center py-8",children:[r.jsxs("p",{className:"text-red-600 dark:text-red-400",children:["Error loading verses: ",Q]}),r.jsx("button",{onClick:()=>window.location.reload(),className:"mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",children:"Retry"})]}),!G&&!Q&&m.length>0&&r.jsxs("div",{children:[ve&&r.jsx("div",{className:"text-center py-4 mb-4",children:r.jsx(Je,{message:"Loading remaining verses..."})}),_e.map((e,t)=>r.jsx("div",{className:"",children:r.jsx("div",{className:"dark:bg-gray-900 rounded-lg p-3 sm:p-4 lg:p-3",children:r.jsxs("div",{className:"text-center",children:[r.jsx("p",{style:{fontFamily:`'${Le}', serif`,textAlign:"justify",textAlignLast:"right",wordSpacing:"0.1em",letterSpacing:"0.02em",lineHeight:2.3,fontSize:`${$e}px`},className:"font-arabic text-gray-900 dark:text-white",dir:"rtl",children:e.verses.map((a,c)=>{const h=e.startVerse+c;return r.jsxs("span",{onClick:()=>Ne(h),className:`inline transition-all duration-300 cursor-pointer hover:bg-cyan-50 dark:hover:bg-cyan-900/40 rounded px-2 ${N===h?"bg-blue-100 dark:bg-blue-900":""}`,title:`Click to play ayah ${h}`,children:[Ie(a.text_uthmani)||a.text_uthmani||""," ﴿",Re(h.toString()),"﴾",c<e.verses.length-1&&"   "]},a.id||`verse-${h}`)})}),e.pageNumber&&r.jsx("div",{id:`page-${e.pageNumber}`,className:"flex items-center justify-center my-6 relative scroll-mt-20",children:r.jsx("div",{className:"w-full  border-b border-gray-300 dark:border-gray-600 py-2 text-center",children:r.jsx("span",{className:"px-4 bg-white dark:bg-gray-900 text-gray-600 dark:text-gray-300 font-semibold",children:e.pageNumber})})})]})})},t)),m.length>0&&$&&r.jsx("div",{className:"mt-8 mb-4",children:r.jsx("div",{className:"text-center text-gray-500 dark:text-gray-400 text-sm mt-4"})})]})]}),r.jsxs("div",{className:"bg-white border-t dark:bg-gray-900 border-gray-200 dark:border-gray-700 px-3 sm:px-4 py-3 sm:py-4 mt-6 sm:mt-8",children:[r.jsxs("div",{className:"sm:hidden space-y-2",children:[r.jsxs("div",{className:"flex space-x-2",children:[r.jsxs("button",{onClick:ie,disabled:parseInt(o)<=1,className:`flex-1 flex items-center justify-center space-x-2 px-4 py-2 text-xs text-gray-600 \r
                           dark:bg-[#323A3F] dark:text-white hover:text-gray-900 dark:hover:text-gray-300 \r
                           border border-gray-300 dark:border-gray-600 rounded-lg w-[173.96px] min-h-[44px]\r
                           disabled:opacity-50 disabled:cursor-not-allowed`,children:[r.jsx(pe,{className:"w-3 h-3"}),r.jsx("span",{children:"Previous Surah"})]}),r.jsxs("button",{onClick:Y,className:`flex-1 flex items-center justify-center space-x-2 px-4 py-2 text-xs text-gray-600 \r
                           dark:bg-[#323A3F] dark:text-white hover:text-gray-900 dark:hover:text-gray-300 \r
                           border border-gray-300 dark:border-gray-600 rounded-lg min-h-[44px]`,children:[r.jsx(Z,{className:"w-3 h-3"}),r.jsx("span",{children:"Beginning of Surah"})]})]}),r.jsx("div",{className:"flex justify-center",children:r.jsxs("button",{onClick:oe,disabled:parseInt(o)>=114,className:`w-[173.96px] flex items-center justify-center space-x-2 px-4 py-2 text-xs text-gray-600 \r
                           dark:bg-[#323A3F] dark:text-white hover:text-gray-900 dark:hover:text-gray-300 \r
                           border border-gray-300 dark:border-gray-600 rounded-lg min-h-[44px]\r
                           disabled:opacity-50 disabled:cursor-not-allowed`,children:[r.jsx("span",{children:"Next Surah"}),r.jsx(me,{className:"w-3 h-3"})]})})]}),r.jsxs("div",{className:"hidden sm:flex max-w-4xl mx-auto items-center justify-center space-x-4 lg:space-x-6",children:[r.jsxs("button",{onClick:ie,disabled:parseInt(o)<=1,className:`flex items-center space-x-2 px-3 sm:px-4 py-2 text-xs sm:text-sm text-gray-600 \r
                         dark:bg-[#323A3F] dark:text-white hover:text-gray-900 dark:hover:text-gray-300 rounded-lg\r
                         disabled:opacity-50 disabled:cursor-not-allowed`,children:[r.jsx(pe,{className:"w-3 h-3 sm:w-4 sm:h-4"}),r.jsx("span",{children:"Previous Surah"})]}),r.jsxs("button",{onClick:Y,className:`flex items-center space-x-2 px-3 sm:px-4 py-2 text-xs sm:text-sm text-gray-600 \r
                         dark:bg-[#323A3F] dark:text-white hover:text-gray-900 dark:hover:text-gray-300 rounded-lg`,children:[r.jsx(Z,{className:"w-3 h-3 sm:w-4 sm:h-4"}),r.jsx("span",{children:"Beginning of Surah"})]}),r.jsxs("button",{onClick:oe,disabled:parseInt(o)>=114,className:`flex items-center space-x-2 px-3 sm:px-4 py-2 text-xs sm:text-sm text-gray-600 \r
                         dark:bg-[#323A3F] dark:text-white hover:text-gray-900 dark:hover:text-gray-300 rounded-lg\r
                         disabled:opacity-50 disabled:cursor-not-allowed`,children:[r.jsx("span",{children:"Next Surah"}),r.jsx(me,{className:"w-3 h-3 sm:w-4 sm:h-4"})]})]})]}),Ee&&r.jsx("button",{onClick:Y,className:`fixed right-6 z-[60] bg-cyan-500 hover:bg-cyan-600 dark:bg-cyan-600 dark:hover:bg-cyan-700 text-white rounded-full p-3 shadow-lg transition-all duration-300 hover:scale-110 flex items-center justify-center ${N?"bottom-32 sm:bottom-36":"bottom-6"}`,title:"Beginning of Surah","aria-label":"Beginning of Surah",children:r.jsx(Z,{className:"w-6 h-6"})}),N&&r.jsx(s.Suspense,{fallback:r.jsx("div",{className:"fixed bottom-0 left-0 right-0 h-20 bg-gray-100 dark:bg-gray-800 animate-pulse"}),children:r.jsx(tt,{audioElement:l,isPlaying:F,currentAyah:N,totalAyahs:m.length,surahInfo:$,onPlayPause:le,onStop:I,onSkipBack:()=>{S>0&&(u(!0),R(S-1,0))},onSkipForward:()=>{S<m.length-1&&(u(!0),R(S+1,0))},onClose:null,selectedQari:w,onQariChange:e=>{re(e),N&&(I(),setTimeout(()=>{S>=0&&(u(!0),R(S))},100))},translationLanguage:C,audioTypes:W,onAudioTypesChange:e=>{const t=S;Se(e),N&&t>=0&&(I(),setTimeout(()=>{u(!0),y(t,0,e)},100))},playbackSpeed:x,onPlaybackSpeedChange:e=>{ae(e)}})})]})]})};export{mt as default};
