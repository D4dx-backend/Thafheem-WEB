import{a6 as d}from"./index-zWRKLUWk.js";import{a as u}from"./apiService-hOh9yyny.js";import"./react-vendor-v5ei6ytj.js";const f=40,y=200;class E{constructor(){this.language="english",this.cache=new Map,this.pendingRequests=new Map}generateCacheKey(n,t){const e=Object.keys(t).sort().map(a=>`${a}=${t[a]}`).join("&");return`${n}${e?`?${e}`:""}`}getCachedData(n){const t=this.cache.get(n);return t&&Date.now()-t.timestamp<3e5?t.data:(t&&this.cache.delete(n),null)}setCachedData(n,t){this.cache.set(n,{data:t,timestamp:Date.now()})}async getAyahTranslation(n,t){const e=this.generateCacheKey("getAyahTranslation",{surahNo:n,ayahNo:t}),a=this.getCachedData(e);if(a)return a;if(this.pendingRequests.has(e))return this.pendingRequests.get(e);const r=this._getAyahTranslationInternal(n,t,e);this.pendingRequests.set(e,r);try{return await r}finally{this.pendingRequests.delete(e)}}async getSurahTranslations(n,t={}){const e=t&&(t.page!==void 0||t.limit!==void 0),a=Number.isInteger(t.page)&&t.page>0?t.page:1,r=Number.isInteger(t.limit)&&t.limit>0?t.limit:f,i=Math.min(r,y),s=this.generateCacheKey("getSurahTranslations",e?{surahNo:n,page:a,limit:i}:{surahNo:n}),g=this.getCachedData(s);if(g)return g;if(this.pendingRequests.has(s))return this.pendingRequests.get(s);const o=this._getSurahTranslationsInternal(n,s,{page:a,limit:i,hasPagination:e});this.pendingRequests.set(s,o);try{return await o}finally{this.pendingRequests.delete(s)}}async getExplanation(n){const t=this.generateCacheKey("getExplanation",{footnoteId:n}),e=this.getCachedData(t);if(e)return e;if(this.pendingRequests.has(t))return this.pendingRequests.get(t);const a=this._getExplanationInternal(n,t);this.pendingRequests.set(t,a);try{return await a}finally{this.pendingRequests.delete(t)}}async getAyahRanges(n){const t=this.generateCacheKey("getAyahRanges",{surahNo:n}),e=this.getCachedData(t);if(e)return e;if(this.pendingRequests.has(t))return this.pendingRequests.get(t);const a=this._getAyahRangesInternal(n,t);this.pendingRequests.set(t,a);try{return await a}finally{this.pendingRequests.delete(t)}}async _getAyahTranslationInternal(n,t,e){try{const a=await u.getTranslation("english",n,t),r=a.translation_text||a.translation||"";return this.setCachedData(e,r),r}catch(a){throw console.error(`Error fetching English translation for ${n}:${t}:`,a),a}}async _getSurahTranslationsInternal(n,t,{page:e,limit:a,hasPagination:r}){try{const i=r?{page:e,limit:a}:{},s=await u.getSurahTranslations("english",n,i),g=s?.translations?.map(h=>({number:h.verse_number,ArabicText:"",Translation:h.translation_text||"",footnote_metadata:h.footnote_metadata||null,interpretations:h.interpretations||[],interpretationCount:h.interpretationCount||0}))||[];if(!r)return this.setCachedData(t,g),g;const o=s?.pagination?{page:s.pagination.page??e,limit:s.pagination.limit??a,totalItems:s.pagination.totalItems??s.pagination.total??null,totalPages:s.pagination.totalPages??null,hasNext:s.pagination.hasNext??!1,hasPrev:s.pagination.hasPrev??e>1,from:s.pagination.from??null,to:s.pagination.to??null}:{page:e,limit:a,totalItems:s?.count??null,totalPages:s?.count?Math.ceil(s.count/a):null,hasNext:g.length===a,hasPrev:e>1,from:g[0]?.number??null,to:g[g.length-1]?.number??null},c={translations:g,pagination:o};return this.setCachedData(t,c),c}catch(i){throw console.error(`Error fetching English surah translations for ${n}:`,i),i}}async getAllInterpretations(n,t){const e=this.generateCacheKey("getAllInterpretations",{surahNo:n,ayahNo:t}),a=this.getCachedData(e);if(a)return a;if(this.pendingRequests.has(e))return this.pendingRequests.get(e);const r=this._getAllInterpretationsInternal(n,t,e);this.pendingRequests.set(e,r);try{return await r}finally{this.pendingRequests.delete(e)}}async _getAllInterpretationsInternal(n,t,e){try{const a=await fetch(`${d}/english/interpretation/all/${n}/${t}`);if(!a.ok){if(a.status===404)return this.setCachedData(e,[]),[];throw new Error(`HTTP error! status: ${a.status}`)}const i=(await a.json()).interpretations||[];return this.setCachedData(e,i),i}catch(a){return console.error(`Error fetching all English interpretations for ${n}:${t}:`,a),this.setCachedData(e,[]),[]}}async _getExplanationInternal(n,t){try{const e=await fetch(`${d}/english/footnote/${n}`);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const r=(await e.json()).footnote_text||"";return this.setCachedData(t,r),r}catch(e){throw console.error(`Error fetching English explanation for footnote ${n}:`,e),e}}async _getAyahRangesInternal(n,t){try{const a=await u.makeRequest(`/english/ayahrange/${n}`)||[];return this.setCachedData(t,a),a}catch(e){throw console.error(`Error fetching English ayah ranges for ${n}:`,e),e}}parseEnglishTranslationWithClickableFootnotes(n,t,e){if(!n)return"";const a=document.createElement("div");a.innerHTML=n;const r=`
      vertical-align: super !important;
      font-size: 0.75em !important;
      line-height: 1 !important;
      margin-left: 2px !important;
      margin-right: 2px !important;
      font-weight: 600 !important;
    `,i=`
      cursor: pointer !important;
      background-color: #19B5DD !important;
      color: #ffffff !important;
      font-weight: 600 !important;
      text-decoration: none !important;
      border: none !important;
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
      font-size: 11px !important;
      line-height: 1 !important;
      border-radius: 9999px !important;
      min-width: 18px !important;
      min-height: 18px !important;
      text-align: center !important;
      transition: all 0.2s ease-in-out !important;
      padding-left: 4px !important;
      padding-right: 4px !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
    `,s=(o,c,h={})=>{if(!o||!/^\d+$/.test(c))return null;o.innerHTML="",o.style.cssText=r;const l=document.createElement("span");return l.className="english-footnote-link",l.style.cssText=i,l.textContent=c,Object.entries(h||{}).forEach(([m,p])=>{p!=null&&p!==""&&l.setAttribute(m,p)}),l.addEventListener("mouseenter",()=>{l.style.backgroundColor="#0ea5e9",l.style.transform="scale(1.05)"}),l.addEventListener("mouseleave",()=>{l.style.backgroundColor="#19B5DD",l.style.transform="scale(1)"}),o.appendChild(l),o.setAttribute("data-english-processed","true"),l};return a.querySelectorAll("sup[foot_note]").forEach(o=>{const c=o.getAttribute("foot_note"),h=o.textContent.trim();c&&h&&s(o,h,{"data-footnote-id":c,"data-surah":t,"data-ayah":e,"data-footnote-number":h})}),a.innerHTML}async getInterpretationByNumber(n,t,e){if(!Number.isFinite(n)||!Number.isFinite(t)||!e)return"";const a=this.generateCacheKey("englishInterpretation",{surahNo:n,ayahNo:t,interpretationNo:e}),r=this.getCachedData(a);if(r)return r;try{const s=(await u.getInterpretation("english",n,t,e))?.explanations||[],o=(s.find(c=>{const h=c.explanation_no_local??c.InterpretationNo??c.interptn_no,l=c.explanation_no_en??c.InterpretationNo??c.interptn_no;return String(h??l??"").trim()===String(e).trim()})||s[0])?.explanation||"";return this.setCachedData(a,o),o}catch(i){throw console.error(`Error fetching English interpretation ${n}:${t} [${e}]:`,i),i}}async getInterpretationById(n){const t=Number.parseInt(n,10);if(!Number.isFinite(t))return"";const e=this.generateCacheKey("englishInterpretationId",{interpretationId:t}),a=this.getCachedData(e);if(a)return a;try{const r=await u.makeRequest(`/english/interpretation/id/${t}`),i=r?.interpretation_text||r?.Interpretation||"";return this.setCachedData(e,i),i}catch(r){throw console.error(`Error fetching English interpretation by ID ${n}:`,r),r}}async isAvailable(){try{return await u.getTranslation("english",1,1),!0}catch(n){return console.warn("English service not available:",n.message),!1}}clearCache(){this.cache.clear(),this.pendingRequests.clear()}destroy(){this.clearCache()}}const _=new E;export{_ as default};
