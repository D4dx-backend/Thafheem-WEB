import{ai as x}from"./index-DJ-cZXxg.js";import{a as m}from"./apiService-D9UdsyGX.js";class b{constructor(){this.language="english",this.cache=new Map,this.pendingRequests=new Map}generateCacheKey(n,t){const e=Object.keys(t).sort().map(a=>`${a}=${t[a]}`).join("&");return`${n}${e?`?${e}`:""}`}getCachedData(n){const t=this.cache.get(n);return t&&Date.now()-t.timestamp<3e5?t.data:(t&&this.cache.delete(n),null)}setCachedData(n,t){this.cache.set(n,{data:t,timestamp:Date.now()})}async getAyahTranslation(n,t){const e=this.generateCacheKey("getAyahTranslation",{surahNo:n,ayahNo:t}),a=this.getCachedData(e);if(a)return a;if(this.pendingRequests.has(e))return this.pendingRequests.get(e);const s=this._getAyahTranslationInternal(n,t,e);this.pendingRequests.set(e,s);try{return await s}finally{this.pendingRequests.delete(e)}}async getSurahTranslations(n){const t=this.generateCacheKey("getSurahTranslations",{surahNo:n}),e=this.getCachedData(t);if(e)return e;if(this.pendingRequests.has(t))return this.pendingRequests.get(t);const a=this._getSurahTranslationsInternal(n,t);this.pendingRequests.set(t,a);try{return await a}finally{this.pendingRequests.delete(t)}}async getExplanation(n){const t=this.generateCacheKey("getExplanation",{footnoteId:n}),e=this.getCachedData(t);if(e)return e;if(this.pendingRequests.has(t))return this.pendingRequests.get(t);const a=this._getExplanationInternal(n,t);this.pendingRequests.set(t,a);try{return await a}finally{this.pendingRequests.delete(t)}}async getAyahRanges(n){const t=this.generateCacheKey("getAyahRanges",{surahNo:n}),e=this.getCachedData(t);if(e)return e;if(this.pendingRequests.has(t))return this.pendingRequests.get(t);const a=this._getAyahRangesInternal(n,t);this.pendingRequests.set(t,a);try{return await a}finally{this.pendingRequests.delete(t)}}async _getAyahTranslationInternal(n,t,e){try{const a=await m.getTranslation("english",n,t),s=a.translation_text||a.translation||"";return this.setCachedData(e,s),s}catch(a){if(a.message?.includes("503")||a.message?.includes("database not available"))return console.warn(`⚠️ English database not available, using Quran.com fallback for ${n}:${t}`),await this._getQuranComAyahFallback(n,t,e);throw console.error(`Error fetching English translation for ${n}:${t}:`,a),a}}async _getQuranComAyahFallback(n,t,e){try{const a=`${n}:${t}`,s=await fetch(`https://api.quran.com/api/v4/verses/by_key/${a}?translations=131&fields=text_uthmani,translations`);if(!s.ok)throw new Error(`Quran.com API error: ${s.status}`);const l=(await s.json()).verse?.translations?.[0]?.text||"";return l&&this.setCachedData(e,l),l}catch(a){throw console.error(`Error fetching Quran.com fallback for ${n}:${t}:`,a),a}}async _getSurahTranslationsInternal(n,t){try{const a=(await m.getSurahTranslations("english",n))?.translations?.map(s=>({number:s.verse_number,ArabicText:"",Translation:s.translation_text||""}))||[];return this.setCachedData(t,a),a}catch(e){if(e.message?.includes("503")||e.message?.includes("database not available"))return console.warn(`⚠️ English database not available, using Quran.com fallback for surah ${n}`),await this._getQuranComFallback(n,t);throw console.error(`Error fetching English surah translations for ${n}:`,e),e}}async _getQuranComFallback(n,t){try{const e=await fetch(`https://api.quran.com/api/v4/chapters/${n}`);if(!e.ok)throw new Error(`Quran.com API error: ${e.status}`);const s=(await e.json()).chapter?.verses_count||0,p=[];for(let l=1;l<=s;l++)try{const o=`${n}:${l}`,c=await fetch(`https://api.quran.com/api/v4/verses/by_key/${o}?translations=131&fields=text_uthmani,translations`);if(c.ok){const r=(await c.json()).verse?.translations?.[0]?.text||"";p.push({number:l,ArabicText:"",Translation:r})}}catch{p.push({number:l,ArabicText:"",Translation:""})}return p.length>0&&this.setCachedData(t,p),p}catch(e){throw console.error(`Error fetching Quran.com fallback for surah ${n}:`,e),e}}async _getExplanationInternal(n,t){try{const e=await fetch(`${x}/english/footnote/${n}`);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const s=(await e.json()).footnote_text||"";return this.setCachedData(t,s),s}catch(e){throw console.error(`Error fetching English explanation for footnote ${n}:`,e),e}}async _getAyahRangesInternal(n,t){try{const a=await m.makeRequest(`/english/ayahrange/${n}`)||[];return this.setCachedData(t,a),a}catch(e){throw console.error(`Error fetching English ayah ranges for ${n}:`,e),e}}parseEnglishTranslationWithClickableFootnotes(n,t,e){if(!n)return"";const a=document.createElement("div");a.innerHTML=n,a.querySelectorAll("sup[foot_note]").forEach(o=>{const c=o.getAttribute("foot_note"),i=o.textContent.trim();if(c&&i){const r=document.createElement("span");r.className="english-footnote-link",r.setAttribute("data-footnote-id",c),r.setAttribute("data-surah",t),r.setAttribute("data-ayah",e),r.setAttribute("title",`Click to view explanation ${i}`),r.textContent=i,r.style.cssText=`
          cursor: pointer !important;
          background-color: #19B5DD !important;
          color: #ffffff !important;
          font-weight: 500 !important;
          text-decoration: none !important;
          border: none !important;
          padding: 4px 8px !important;
          margin: 0 4px !important;
          display: inline-flex !important;
          align-items: center !important;
          justify-content: center !important;
          font-size: 12px !important;
          vertical-align: middle !important;
          line-height: 1 !important;
          border-radius: 50% !important;
          position: relative !important;
          top: 0 !important;
          min-width: 24px !important;
          min-height: 24px !important;
          text-align: center !important;
          transition: all 0.2s ease-in-out !important;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        `,r.addEventListener("mouseenter",()=>{r.style.backgroundColor="#0ea5e9",r.style.transform="scale(1.1)"}),r.addEventListener("mouseleave",()=>{r.style.backgroundColor="#19B5DD",r.style.transform="scale(1)"}),o.parentNode.replaceChild(r,o)}}),a.querySelectorAll("sup:not([foot_note])").forEach(o=>{const c=(o.textContent||"").trim();if(!/^[0-9]+$/.test(c))return;const i=document.createElement("span");i.className="english-footnote-link",i.setAttribute("data-footnote-id",c),i.setAttribute("data-surah",t),i.setAttribute("data-ayah",e),i.setAttribute("title",`Click to view explanation ${c}`),i.textContent=c,i.style.cssText=`
        cursor: pointer !important;
        background-color: #19B5DD !important;
        color: #ffffff !important;
        font-weight: 500 !important;
        text-decoration: none !important;
        border: none !important;
        padding: 4px 8px !important;
        margin: 0 4px !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        font-size: 12px !important;
        vertical-align: middle !important;
        line-height: 1 !important;
        border-radius: 50% !important;
        position: relative !important;
        top: 0 !important;
        min-width: 24px !important;
        min-height: 24px !important;
        text-align: center !important;
        transition: all 0.2s ease-in-out !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
      `,o.parentNode.replaceChild(i,o)});function l(o){const c=document.createTreeWalker(o,NodeFilter.SHOW_TEXT,null),i=[];for(;c.nextNode();){const r=c.currentNode,u=r.nodeValue;u&&/\(\d+\)/.test(u)&&i.push(r)}i.forEach(r=>{const u=document.createDocumentFragment();r.nodeValue.split(/(\(\d+\))/g).forEach(g=>{const f=g.match(/^\((\d+)\)$/);if(f){const d=f[1],h=document.createElement("span");h.className="english-footnote-link",h.setAttribute("data-footnote-id",d),h.setAttribute("data-surah",t),h.setAttribute("data-ayah",e),h.setAttribute("title",`Click to view explanation ${d}`),h.textContent=d,h.style.cssText=`
              cursor: pointer !important;
              background-color: #19B5DD !important;
              color: #ffffff !important;
              font-weight: 500 !important;
              text-decoration: none !important;
              border: none !important;
              padding: 4px 8px !important;
              margin: 0 4px !important;
              display: inline-flex !important;
              align-items: center !important;
              justify-content: center !important;
              font-size: 12px !important;
              vertical-align: middle !important;
              line-height: 1 !important;
              border-radius: 50% !important;
              position: relative !important;
              top: 0 !important;
              min-width: 24px !important;
              min-height: 24px !important;
              text-align: center !important;
              transition: all 0.2s ease-in-out !important;
              box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
            `,u.appendChild(h)}else u.appendChild(document.createTextNode(g))}),r.parentNode.replaceChild(u,r)})}return l(a),a.innerHTML}async isAvailable(){try{return await m.getTranslation("english",1,1),!0}catch(n){return console.warn("English service not available:",n.message),!1}}clearCache(){this.cache.clear(),this.pendingRequests.clear()}destroy(){this.clearCache()}}const E=new b;export{E as default};
