import{ak as y}from"./index-DwV6Sgdl.js";import{a as g}from"./apiService-BdQWyFVk.js";class w{constructor(){this.language="english",this.cache=new Map,this.pendingRequests=new Map}generateCacheKey(n,t){const e=Object.keys(t).sort().map(a=>`${a}=${t[a]}`).join("&");return`${n}${e?`?${e}`:""}`}getCachedData(n){const t=this.cache.get(n);return t&&Date.now()-t.timestamp<3e5?t.data:(t&&this.cache.delete(n),null)}setCachedData(n,t){this.cache.set(n,{data:t,timestamp:Date.now()})}async getAyahTranslation(n,t){const e=this.generateCacheKey("getAyahTranslation",{surahNo:n,ayahNo:t}),a=this.getCachedData(e);if(a)return a;if(this.pendingRequests.has(e))return this.pendingRequests.get(e);const r=this._getAyahTranslationInternal(n,t,e);this.pendingRequests.set(e,r);try{return await r}finally{this.pendingRequests.delete(e)}}async getSurahTranslations(n){const t=this.generateCacheKey("getSurahTranslations",{surahNo:n}),e=this.getCachedData(t);if(e)return e;if(this.pendingRequests.has(t))return this.pendingRequests.get(t);const a=this._getSurahTranslationsInternal(n,t);this.pendingRequests.set(t,a);try{return await a}finally{this.pendingRequests.delete(t)}}async getExplanation(n){const t=this.generateCacheKey("getExplanation",{footnoteId:n}),e=this.getCachedData(t);if(e)return e;if(this.pendingRequests.has(t))return this.pendingRequests.get(t);const a=this._getExplanationInternal(n,t);this.pendingRequests.set(t,a);try{return await a}finally{this.pendingRequests.delete(t)}}async getAyahRanges(n){const t=this.generateCacheKey("getAyahRanges",{surahNo:n}),e=this.getCachedData(t);if(e)return e;if(this.pendingRequests.has(t))return this.pendingRequests.get(t);const a=this._getAyahRangesInternal(n,t);this.pendingRequests.set(t,a);try{return await a}finally{this.pendingRequests.delete(t)}}async _getAyahTranslationInternal(n,t,e){try{const a=await g.getTranslation("english",n,t),r=a.translation_text||a.translation||"";return this.setCachedData(e,r),r}catch(a){if(a.message?.includes("503")||a.message?.includes("database not available"))return console.warn(`⚠️ English database not available, using Quran.com fallback for ${n}:${t}`),await this._getQuranComAyahFallback(n,t,e);throw console.error(`Error fetching English translation for ${n}:${t}:`,a),a}}async _getQuranComAyahFallback(n,t,e){try{const a=`${n}:${t}`,r=await fetch(`https://api.quran.com/api/v4/verses/by_key/${a}?translations=131&fields=text_uthmani,translations`);if(!r.ok)throw new Error(`Quran.com API error: ${r.status}`);const p=(await r.json()).verse?.translations?.[0]?.text||"";return p&&this.setCachedData(e,p),p}catch(a){throw console.error(`Error fetching Quran.com fallback for ${n}:${t}:`,a),a}}async _getSurahTranslationsInternal(n,t){try{const a=(await g.getSurahTranslations("english",n))?.translations?.map(r=>({number:r.verse_number,ArabicText:"",Translation:r.translation_text||""}))||[];return this.setCachedData(t,a),a}catch(e){if(e.message?.includes("503")||e.message?.includes("database not available"))return console.warn(`⚠️ English database not available, using Quran.com fallback for surah ${n}`),await this._getQuranComFallback(n,t);throw console.error(`Error fetching English surah translations for ${n}:`,e),e}}async _getQuranComFallback(n,t){try{const e=await fetch(`https://api.quran.com/api/v4/chapters/${n}`);if(!e.ok)throw new Error(`Quran.com API error: ${e.status}`);const r=(await e.json()).chapter?.verses_count||0,m=[];for(let p=1;p<=r;p++)try{const f=`${n}:${p}`,d=await fetch(`https://api.quran.com/api/v4/verses/by_key/${f}?translations=131&fields=text_uthmani,translations`);if(d.ok){const s=(await d.json()).verse?.translations?.[0]?.text||"";m.push({number:p,ArabicText:"",Translation:s})}}catch{m.push({number:p,ArabicText:"",Translation:""})}return m.length>0&&this.setCachedData(t,m),m}catch(e){throw console.error(`Error fetching Quran.com fallback for surah ${n}:`,e),e}}async _getExplanationInternal(n,t){try{const e=await fetch(`${y}/english/footnote/${n}`);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const r=(await e.json()).footnote_text||"";return this.setCachedData(t,r),r}catch(e){throw console.error(`Error fetching English explanation for footnote ${n}:`,e),e}}async _getAyahRangesInternal(n,t){try{const a=await g.makeRequest(`/english/ayahrange/${n}`)||[];return this.setCachedData(t,a),a}catch(e){throw console.error(`Error fetching English ayah ranges for ${n}:`,e),e}}parseEnglishTranslationWithClickableFootnotes(n,t,e,a=null){if(!n)return"";const r=document.createElement("div");r.innerHTML=n,r.querySelectorAll("sup:not([foot_note])").forEach(i=>{const s=i.textContent.trim();/^\d+$/.test(s)&&!i.hasAttribute("data-footnote-id")&&(i.style.cssText=`
          cursor: pointer !important;
          background-color: rgb(41 169 199) !important;
          color: rgb(255, 255, 255) !important;
          font-weight: 600 !important;
          text-decoration: none !important;
          border: none !important;
          display: inline-flex !important;
          align-items: center !important;
          justify-content: center !important;
          font-size: 12px !important;
          vertical-align: middle !important;
          line-height: 1 !important;
          border-radius: 9999px !important;
          position: relative !important;
          z-index: 10 !important;
          top: 0px !important;
          min-width: 20px !important;
          min-height: 19px !important;
          text-align: center !important;
          transition: 0.2s ease-in-out !important;
          padding-top: 3px !important;
          margin-right: 4px;
          margin-left: -1px;
          margin-top: -15px;
          padding-left: 2px !important;
          padding-right: 2px !important;
        `,i.setAttribute("data-interpretation",s),a?i.setAttribute("data-range",a):i.setAttribute("data-range",`${e}-${e}`),i.setAttribute("data-lang","E"),i.setAttribute("title",`Click to view interpretation ${s}`),i.setAttribute("aria-label",`Interpretation ${s}`),i.setAttribute("data-interpretation-label",s),i.setAttribute("data-interpretation-number",s),i.className="interpretation-link",a&&(i.textContent="i"))}),r.querySelectorAll("sup[foot_note]").forEach(i=>{const s=i.getAttribute("foot_note"),c=i.textContent.trim();if(s&&c){const o=document.createElement("span");o.className="english-footnote-link",o.setAttribute("data-footnote-id",s),o.setAttribute("data-surah",t),o.setAttribute("data-ayah",e),o.setAttribute("data-footnote-number",c),o.setAttribute("data-interpretation-number",c),o.setAttribute("data-interpretation",c),o.setAttribute("title",`Click to view explanation ${c}`),o.textContent=a?"i":c,o.style.cssText=`
          cursor: pointer !important;
          background-color: #19B5DD !important;
          color: #ffffff !important;
          font-weight: 500 !important;
          text-decoration: none !important;
          border: none !important;
          padding: 4px 8px !important;
          margin: 0 4px !important;
          display: inline-flex !important;
          align-items: center !important;
          justify-content: center !important;
          font-size: 12px !important;
          vertical-align: middle !important;
          line-height: 1 !important;
          border-radius: 50% !important;
          position: relative !important;
          top: 0 !important;
          min-width: 24px !important;
          min-height: 24px !important;
          text-align: center !important;
          transition: all 0.2s ease-in-out !important;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        `,o.addEventListener("mouseenter",()=>{o.style.backgroundColor="#0ea5e9",o.style.transform="scale(1.1)"}),o.addEventListener("mouseleave",()=>{o.style.backgroundColor="#19B5DD",o.style.transform="scale(1)"}),i.parentNode.replaceChild(o,i)}}),r.querySelectorAll("sup:not([foot_note])").forEach(i=>{const s=(i.textContent||"").trim();if(!/^[0-9]+$/.test(s))return;const c=document.createElement("span");c.className="english-footnote-link",c.setAttribute("data-footnote-id",s),c.setAttribute("data-surah",t),c.setAttribute("data-ayah",e),c.setAttribute("data-footnote-number",s),c.setAttribute("data-interpretation-number",s),c.setAttribute("data-interpretation",s),c.setAttribute("title",`Click to view explanation ${s}`),c.textContent=a?"i":s,c.style.cssText=`
        cursor: pointer !important;
        background-color: #19B5DD !important;
        color: #ffffff !important;
        font-weight: 500 !important;
        text-decoration: none !important;
        border: none !important;
        padding: 4px 8px !important;
        margin: 0 4px !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        font-size: 12px !important;
        vertical-align: middle !important;
        line-height: 1 !important;
        border-radius: 50% !important;
        position: relative !important;
        top: 0 !important;
        min-width: 24px !important;
        min-height: 24px !important;
        text-align: center !important;
        transition: all 0.2s ease-in-out !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
      `,i.parentNode.replaceChild(c,i)});function d(i){const s=document.createTreeWalker(i,NodeFilter.SHOW_TEXT,null),c=[];for(;s.nextNode();){const o=s.currentNode,h=o.nodeValue;h&&/\(\d+\)/.test(h)&&c.push(o)}c.forEach(o=>{const h=document.createDocumentFragment();o.nodeValue.split(/(\(\d+\))/g).forEach(b=>{const x=b.match(/^\((\d+)\)$/);if(x){const u=x[1],l=document.createElement("span");l.className="english-footnote-link",l.setAttribute("data-footnote-id",u),l.setAttribute("data-surah",t),l.setAttribute("data-ayah",e),l.setAttribute("data-footnote-number",u),l.setAttribute("data-interpretation-number",u),l.setAttribute("data-interpretation",u),l.setAttribute("title",`Click to view explanation ${u}`),l.textContent=a?"i":u,l.style.cssText=`
              cursor: pointer !important;
              background-color: #19B5DD !important;
              color: #ffffff !important;
              font-weight: 500 !important;
              text-decoration: none !important;
              border: none !important;
              padding: 4px 8px !important;
              margin: 0 4px !important;
              display: inline-flex !important;
              align-items: center !important;
              justify-content: center !important;
              font-size: 12px !important;
              vertical-align: middle !important;
              line-height: 1 !important;
              border-radius: 50% !important;
              position: relative !important;
              top: 0 !important;
              min-width: 24px !important;
              min-height: 24px !important;
              text-align: center !important;
              transition: all 0.2s ease-in-out !important;
              box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
            `,h.appendChild(l)}else h.appendChild(document.createTextNode(b))}),o.parentNode.replaceChild(h,o)})}return d(r),r.innerHTML}async isAvailable(){try{return await g.getTranslation("english",1,1),!0}catch(n){return console.warn("English service not available:",n.message),!1}}clearCache(){this.cache.clear(),this.pendingRequests.clear()}destroy(){this.clearCache()}}const $=new w;export{$ as default};
