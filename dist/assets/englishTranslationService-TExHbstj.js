import{ag as d}from"./index-D0NMIq43.js";import{a as u}from"./apiService-Be4cmTqe.js";import"./react-vendor-v5ei6ytj.js";const f=40,y=200;class E{constructor(){this.language="english",this.cache=new Map,this.pendingRequests=new Map}generateCacheKey(a,t){const e=Object.keys(t).sort().map(n=>`${n}=${t[n]}`).join("&");return`${a}${e?`?${e}`:""}`}getCachedData(a){const t=this.cache.get(a);return t&&Date.now()-t.timestamp<3e5?t.data:(t&&this.cache.delete(a),null)}setCachedData(a,t){this.cache.set(a,{data:t,timestamp:Date.now()})}async getAyahTranslation(a,t){const e=this.generateCacheKey("getAyahTranslation",{surahNo:a,ayahNo:t}),n=this.getCachedData(e);if(n)return n;if(this.pendingRequests.has(e))return this.pendingRequests.get(e);const r=this._getAyahTranslationInternal(a,t,e);this.pendingRequests.set(e,r);try{return await r}finally{this.pendingRequests.delete(e)}}async getSurahTranslations(a,t={}){const e=t&&(t.page!==void 0||t.limit!==void 0),n=Number.isInteger(t.page)&&t.page>0?t.page:1,r=Number.isInteger(t.limit)&&t.limit>0?t.limit:f,i=Math.min(r,y),s=this.generateCacheKey("getSurahTranslations",e?{surahNo:a,page:n,limit:i}:{surahNo:a}),g=this.getCachedData(s);if(g)return g;if(this.pendingRequests.has(s))return this.pendingRequests.get(s);const c=this._getSurahTranslationsInternal(a,s,{page:n,limit:i,hasPagination:e});this.pendingRequests.set(s,c);try{return await c}finally{this.pendingRequests.delete(s)}}async getExplanation(a){const t=this.generateCacheKey("getExplanation",{footnoteId:a}),e=this.getCachedData(t);if(e)return e;if(this.pendingRequests.has(t))return this.pendingRequests.get(t);const n=this._getExplanationInternal(a,t);this.pendingRequests.set(t,n);try{return await n}finally{this.pendingRequests.delete(t)}}async getAyahRanges(a){const t=this.generateCacheKey("getAyahRanges",{surahNo:a}),e=this.getCachedData(t);if(e)return e;if(this.pendingRequests.has(t))return this.pendingRequests.get(t);const n=this._getAyahRangesInternal(a,t);this.pendingRequests.set(t,n);try{return await n}finally{this.pendingRequests.delete(t)}}async _getAyahTranslationInternal(a,t,e){try{const n=await u.getTranslation("english",a,t),r=n.translation_text||n.translation||"";return this.setCachedData(e,r),r}catch(n){throw console.error(`Error fetching English translation for ${a}:${t}:`,n),n}}async _getSurahTranslationsInternal(a,t,{page:e,limit:n,hasPagination:r}){try{const i=r?{page:e,limit:n}:{},s=await u.getSurahTranslations("english",a,i),g=s?.translations?.map(h=>({number:h.verse_number,ArabicText:"",Translation:h.translation_text||"",footnote_metadata:h.footnote_metadata||null,interpretations:h.interpretations||[],interpretationCount:h.interpretationCount||0}))||[];if(!r)return this.setCachedData(t,g),g;const c=s?.pagination?{page:s.pagination.page??e,limit:s.pagination.limit??n,totalItems:s.pagination.totalItems??s.pagination.total??null,totalPages:s.pagination.totalPages??null,hasNext:s.pagination.hasNext??!1,hasPrev:s.pagination.hasPrev??e>1,from:s.pagination.from??null,to:s.pagination.to??null}:{page:e,limit:n,totalItems:s?.count??null,totalPages:s?.count?Math.ceil(s.count/n):null,hasNext:g.length===n,hasPrev:e>1,from:g[0]?.number??null,to:g[g.length-1]?.number??null},o={translations:g,pagination:c};return this.setCachedData(t,o),o}catch(i){throw console.error(`Error fetching English surah translations for ${a}:`,i),i}}async getAllInterpretations(a,t){const e=this.generateCacheKey("getAllInterpretations",{surahNo:a,ayahNo:t}),n=this.getCachedData(e);if(n)return n;if(this.pendingRequests.has(e))return this.pendingRequests.get(e);const r=this._getAllInterpretationsInternal(a,t,e);this.pendingRequests.set(e,r);try{return await r}finally{this.pendingRequests.delete(e)}}async _getAllInterpretationsInternal(a,t,e){try{const n=await fetch(`${d}/english/interpretation/all/${a}/${t}`);if(!n.ok){if(n.status===404)return this.setCachedData(e,[]),[];throw new Error(`HTTP error! status: ${n.status}`)}const i=(await n.json()).interpretations||[];return this.setCachedData(e,i),i}catch(n){return console.error(`Error fetching all English interpretations for ${a}:${t}:`,n),this.setCachedData(e,[]),[]}}async _getExplanationInternal(a,t){try{const e=await fetch(`${d}/english/footnote/${a}`);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const r=(await e.json()).footnote_text||"";return this.setCachedData(t,r),r}catch(e){throw console.error(`Error fetching English explanation for footnote ${a}:`,e),e}}async _getAyahRangesInternal(a,t){try{const n=await u.makeRequest(`/english/ayahrange/${a}`)||[];return this.setCachedData(t,n),n}catch(e){throw console.error(`Error fetching English ayah ranges for ${a}:`,e),e}}parseEnglishTranslationWithClickableFootnotes(a,t,e){if(!a)return"";const n=document.createElement("div");n.innerHTML=a;const r=`
      vertical-align: super !important;
      font-size: 0.75em !important;
      line-height: 1 !important;
      margin-left: 2px !important;
      margin-right: 2px !important;
      font-weight: 600 !important;
    `,i=`
      cursor: pointer !important;
      background-color: transparent !important;
      color: #19B5DD !important;
      font-weight: 600 !important;
      text-decoration: none !important;
      border: none !important;
      display: inline !important;
      font-size: 11px !important;
      line-height: 1 !important;
      position: relative !important;
      top: 0px !important;
      transition: all 0.2s ease-in-out !important;
    `,s=(c,o,h={})=>{if(!c||!/^\d+$/.test(o))return null;c.innerHTML="",c.style.cssText=r;const l=document.createElement("span");return l.className="english-footnote-link",l.style.cssText=i,l.textContent=o,Object.entries(h||{}).forEach(([m,p])=>{p!=null&&p!==""&&l.setAttribute(m,p)}),l.addEventListener("mouseenter",()=>{l.style.backgroundColor="#0ea5e9",l.style.transform="scale(1.05)"}),l.addEventListener("mouseleave",()=>{l.style.backgroundColor="#19B5DD",l.style.transform="scale(1)"}),c.appendChild(l),c.setAttribute("data-english-processed","true"),l};return n.querySelectorAll("sup[foot_note]").forEach(c=>{const o=c.getAttribute("foot_note"),h=c.textContent.trim();o&&h&&s(c,h,{"data-footnote-id":o,"data-surah":t,"data-ayah":e,"data-footnote-number":h})}),n.innerHTML}async getInterpretationByNumber(a,t,e){if(!Number.isFinite(a)||!Number.isFinite(t)||!e)return"";const n=this.generateCacheKey("englishInterpretation",{surahNo:a,ayahNo:t,interpretationNo:e}),r=this.getCachedData(n);if(r)return r;try{const i=await u.getInterpretation("english",a,t,e);if(i?.interpretation){const o=i.interpretation||"";return this.setCachedData(n,o),o}const s=i?.explanations||[],c=(s.find(o=>{const h=o.explanation_no_local??o.InterpretationNo??o.interptn_no,l=o.explanation_no_en??o.InterpretationNo??o.interptn_no;return String(h??l??"").trim()===String(e).trim()})||s[0])?.explanation||"";return this.setCachedData(n,c),c}catch(i){throw console.error(`Error fetching English interpretation ${a}:${t} [${e}]:`,i),i}}async getInterpretationById(a){const t=Number.parseInt(a,10);if(!Number.isFinite(t))return"";const e=this.generateCacheKey("englishInterpretationId",{interpretationId:t}),n=this.getCachedData(e);if(n)return n;try{const r=await u.makeRequest(`/english/interpretation/id/${t}`),i=r?.interpretation_text||r?.Interpretation||"";return this.setCachedData(e,i),i}catch(r){throw console.error(`Error fetching English interpretation by ID ${a}:`,r),r}}async isAvailable(){try{return await u.getTranslation("english",1,1),!0}catch(a){return console.warn("English service not available:",a.message),!1}}clearCache(){this.cache.clear(),this.pendingRequests.clear()}destroy(){this.clearCache()}}const w=new E;export{w as default};
