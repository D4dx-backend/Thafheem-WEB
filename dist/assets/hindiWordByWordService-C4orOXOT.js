class _{constructor(){this.dbPath="/quran_hindi.db".replace(/\/+/g,"/"),this.cache=new Map,this.dbPromise=null,this.isDownloaded=!1}async initDB(){return this.dbPromise?this.dbPromise:(this.dbPromise=(async()=>{try{await new Promise(s=>{const r=()=>{window.initSqlJs?s():setTimeout(r,100)};r()});const t=await window.initSqlJs({locateFile:s=>`https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${s}`});let e,n=this.dbPath;if(e=await fetch(n),!e.ok){const s="/quran_hindi.db";if(n!==s){if(console.warn(`⚠️ Failed to fetch from ${n} (${e.status}), trying root path: ${s}`),n=s,e=await fetch(s),!e.ok)throw console.error(`❌ Failed to fetch Hindi word-by-word DB from ${s}: ${e.status} ${e.statusText}`),new Error(`Failed to fetch database: ${e.status} ${e.statusText}`)}else throw console.error(`❌ Failed to fetch Hindi word-by-word DB from ${n}: ${e.status} ${e.statusText}`),new Error(`Failed to fetch database: ${e.status} ${e.statusText}`)}const d=await e.arrayBuffer(),o=new t.Database(new Uint8Array(d)),a=o.exec("SELECT name FROM sqlite_master WHERE type='table'"),h=o.exec("SELECT COUNT(*) as count FROM hindi_wordmeanings")[0]?.values[0]?.[0]||0;return this.isDownloaded=!0,o}catch(t){throw console.error("❌ Failed to load Hindi database:",t),new Error(`Failed to load Hindi translation database: ${t.message}`)}})(),this.dbPromise)}isHindiWord(t){return t?/[\u0900-\u097F]/.test(t):!1}isEnglishWord(t){if(!t)return!1;const e=t.replace(/[()[\]{}.,;:!?'"]/g,"").trim();return/^[a-zA-Z\s]+$/.test(e)&&e.length>0}async getWordByWordData(t,e){const n=`wordbyword-${t}-${e}`;if(this.cache.has(n))return this.cache.get(n);try{const d=await this.initDB(),o=d.prepare(`
        SELECT WordId, WordPhrase, WordMeaning 
        FROM hindi_wordmeanings 
        WHERE SuraId = ? AND AyaId = ?
        ORDER BY WordId ASC
      `);o.bind([t,e]);const a=[];let i=0;for(;o.step();){const r=o.getAsObject(),l=r.WordMeaning||"";this.isHindiWord(l)?(a.push({id:r.WordId||i+1,position:i+1,audio_url:null,char_type_name:"word",code_v1:"",code_v2:"",line_number:1,page_number:1,text_uthmani:r.WordPhrase||"",text_simple:r.WordPhrase||"",translation:{text:l,language_name:"Hindi",resource_name:"Local Hindi Database"},transliteration:{text:"",language_name:"English"}}),i+=1):this.isEnglishWord(l)?(a.push({id:r.WordId||i+1,position:i+1,audio_url:null,char_type_name:"word",code_v1:"",code_v2:"",line_number:1,page_number:1,text_uthmani:r.WordPhrase||"",text_simple:r.WordPhrase||"",translation:{text:l,language_name:"English (Hindi not available)",resource_name:"Local Hindi Database (English fallback)"},transliteration:{text:"",language_name:"English"}}),i+=1):(a.push({id:r.WordId||i+1,position:i+1,audio_url:null,char_type_name:"word",code_v1:"",code_v2:"",line_number:1,page_number:1,text_uthmani:r.WordPhrase||"",text_simple:r.WordPhrase||"",translation:{text:l||"Translation not available",language_name:"Mixed",resource_name:"Local Hindi Database"},transliteration:{text:"",language_name:"English"}}),i+=1)}if(o.free(),a.length>0){const r={text_uthmani:a.map(c=>c.text_uthmani).join(" "),words:a,translations:[{text:a.map(c=>c.translation.text).join(" "),language_name:"Hindi",resource_name:"Local Hindi Database"}]},l=a.filter(c=>c.translation.language_name==="Hindi").length,u=a.filter(c=>c.translation.language_name==="English (Hindi not available)").length;return this.cache.set(n,r),r}console.warn(`⚠️ No Hindi word meanings found for ${t}:${e}`);const h=d.prepare(`
        SELECT COUNT(*) as count 
        FROM hindi_wordmeanings 
        WHERE SuraId = ?
      `),s=h.getAsObject([t]);return h.free(),null}catch(d){throw console.error(`❌ Error fetching Hindi word-by-word data for ${t}:${e}:`,d),d}}async getWordByWordDataWithArabic(t,e){try{const n=await this.getWordByWordData(t,e);if(!n)return console.warn(`⚠️ No Hindi data found for ${t}:${e}, falling back to English`),await this.getEnglishFallback(t,e);const o=`https://api.quran.com/api/v4/verses/by_key/${`${t}:${e}`}?words=true&word_fields=verse_key,word_number,location,text_uthmani,text_simple,class_name,line_number,page_number,code_v1,qpc_uthmani_hafs`;try{const a=await fetch(o);if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const i=await a.json();if(i.verse&&i.verse.words){const h=i.verse.words.map((s,r)=>{let l=n.words[r];return(!l||l.text_uthmani&&l.text_uthmani!==s.text_uthmani)&&(l=n.words.find(u=>u.text_uthmani===s.text_uthmani||u.text_simple===s.text_simple)),{...s,translation:l?l.translation:{text:"Translation not available",language_name:"Hindi",resource_name:"Local Hindi Database"}}});return{...i.verse,words:h,translations:n.translations}}}catch(a){return console.warn("Failed to fetch Arabic words from API, using Hindi-only data:",a),n}return n}catch(n){return console.error(`❌ Error fetching combined Hindi word-by-word data for ${t}:${e}:`,n),console.warn(`⚠️ Error with Hindi data, falling back to English for ${t}:${e}`),await this.getEnglishFallback(t,e)}}async getEnglishFallback(t,e){try{const d=`https://api.quran.com/api/v4/verses/by_key/${`${t}:${e}`}?words=true&word_fields=verse_key,word_number,location,text_uthmani,text_simple,class_name,line_number,page_number,code_v1,qpc_uthmani_hafs,translation&translation_fields=resource_name,language_name&language=en&translations=131`,o=await fetch(d);if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const a=await o.json();return a.verse?(a.verse.translations&&a.verse.translations.length>0&&(a.verse.translations[0].resource_name="English Fallback (Hindi not available)"),a.verse):null}catch(n){return console.error(`❌ Error fetching English fallback for ${t}:${e}:`,n),null}}async isAvailable(){try{return await this.initDB(),!0}catch(t){return console.warn("Hindi word-by-word service not available:",t.message),!1}}isDatabaseDownloaded(){return this.isDownloaded}clearCache(){this.cache.clear()}getCacheStats(){return{size:this.cache.size,keys:Array.from(this.cache.keys())}}}const g=new _;export{g as default};
