class m{constructor(){this.dbPath="/quran_tamil.db",this.cache=new Map,this.dbPromise=null,this.isDownloaded=!1}async initDB(){return this.dbPromise?this.dbPromise:(this.dbPromise=(async()=>{try{await new Promise(l=>{const i=()=>{window.initSqlJs?l():setTimeout(i,100)};i()});const t=await window.initSqlJs({locateFile:l=>`https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${l}`}),e=await fetch(this.dbPath);if(!e.ok)throw new Error(`Failed to fetch database: ${e.status} ${e.statusText}`);const a=await e.arrayBuffer(),s=new t.Database(new Uint8Array(a)),n=s.exec("SELECT name FROM sqlite_master WHERE type='table'"),o=s.exec("SELECT COUNT(*) as count FROM tamil_translations")[0]?.values[0]?.[0]||0;return this.isDownloaded=!0,s}catch(t){throw console.error("❌ Failed to load Tamil database:",t),new Error(`Failed to load Tamil translation database: ${t.message}`)}})(),this.dbPromise)}parseTamilTranslation(t){return t?t.split(/[\s,\.;:!?]+/).filter(a=>a.trim().length>0).map(a=>a.trim()):[]}async getWordByWordData(t,e){const a=`wordbyword-${t}-${e}`;if(this.cache.has(a))return this.cache.get(a);try{const n=(await this.initDB()).prepare(`
        SELECT translation_text 
        FROM tamil_translations 
        WHERE chapter_number = ? AND verse_number = ?
      `),r=n.getAsObject([t,e]);if(n.free(),r&&r.translation_text){const o=r.translation_text,i={text_uthmani:"",words:this.parseTamilTranslation(o).map((d,c)=>({id:c+1,position:c+1,audio_url:null,char_type_name:"word",code_v1:"",code_v2:"",line_number:1,page_number:1,text_uthmani:"",text_simple:"",translation:{text:d,language_name:"Tamil",resource_name:"Local Tamil Database"},transliteration:{text:"",language_name:"English"}})),translations:[{text:o,language_name:"Tamil",resource_name:"Local Tamil Database"}]};return this.cache.set(a,i),i}return console.warn(`⚠️ No Tamil translation found for ${t}:${e}`),null}catch(s){throw console.error(`❌ Error fetching Tamil word-by-word data for ${t}:${e}:`,s),s}}async getWordByWordDataWithArabic(t,e){try{const a=await this.getWordByWordData(t,e);if(!a)return console.warn(`⚠️ No Tamil data found for ${t}:${e}, falling back to English`),await this.getEnglishFallback(t,e);const n=`https://api.quran.com/api/v4/verses/by_key/${`${t}:${e}`}?words=true&word_fields=verse_key,word_number,location,text_uthmani,text_simple,class_name,line_number,page_number,code_v1,qpc_uthmani_hafs`;try{const r=await fetch(n);if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const o=await r.json();if(o.verse&&o.verse.words){const l=o.verse.words.map((i,d)=>{const c=a.words[d];return{...i,translation:c?c.translation:{text:"Translation not available",language_name:"Tamil",resource_name:"Local Tamil Database"}}});return{...o.verse,words:l,translations:a.translations}}}catch(r){return console.warn("Failed to fetch Arabic words from API, using Tamil-only data:",r),a}return a}catch(a){return console.error(`❌ Error fetching combined Tamil word-by-word data for ${t}:${e}:`,a),console.warn(`⚠️ Error with Tamil data, falling back to English for ${t}:${e}`),await this.getEnglishFallback(t,e)}}async getEnglishFallback(t,e){try{const s=`https://api.quran.com/api/v4/verses/by_key/${`${t}:${e}`}?words=true&word_fields=verse_key,word_number,location,text_uthmani,text_simple,class_name,line_number,page_number,code_v1,qpc_uthmani_hafs,translation&translation_fields=resource_name,language_name&language=en&translations=131`,n=await fetch(s);if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const r=await n.json();return r.verse?(r.verse.translations&&r.verse.translations.length>0&&(r.verse.translations[0].resource_name="English Fallback (Tamil not available)"),r.verse):null}catch(a){return console.error(`❌ Error fetching English fallback for ${t}:${e}:`,a),null}}async isAvailable(){try{return await this.initDB(),!0}catch(t){return console.warn("Tamil word-by-word service not available:",t.message),!1}}isDatabaseDownloaded(){return this.isDownloaded}clearCache(){this.cache.clear()}getCacheStats(){return{size:this.cache.size,keys:Array.from(this.cache.keys())}}}const u=new m;export{u as default};
