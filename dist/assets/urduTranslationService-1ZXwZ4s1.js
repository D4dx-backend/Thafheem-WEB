import{ac as g}from"./index-CQnsQrCL.js";import{a as h}from"./apiService-71VjOsf1.js";import"./react-vendor-v5ei6ytj.js";const p=40,m=200;class f{constructor(){this.language="urdu",this.apiBasePath=g,this.pendingRequests=new Map,this.cache=new Map,this.cacheEnabled=!0,this.cacheTtl=3e5,this.footnoteOrderMap=new Map}normalizeSurahNo(e){const t=Number.parseInt(e,10);return Number.isFinite(t)?t:null}resetFootnoteOrdering(e){if(e==null){this.footnoteOrderMap.clear();return}const t=this.normalizeSurahNo(e);t!==null&&this.footnoteOrderMap.delete(t)}getOrAssignFootnoteNumber(e,t,a){if(!t)return Number.isFinite(a)?a:null;const n=this.normalizeSurahNo(e);if(n===null)return Number.isFinite(a)?a:null;this.footnoteOrderMap.has(n)||this.footnoteOrderMap.set(n,new Map);const r=this.footnoteOrderMap.get(n);if(r.has(t))return r.get(t);const i=r.size+1;return r.set(t,i),i}generateCacheKey(e,t){const a=Object.keys(t).sort().map(n=>`${n}=${t[n]}`).join("&");return`${e}${a?`?${a}`:""}`}isCacheValid(e){return Date.now()-e<this.cacheTtl}getCachedData(e){if(!this.cacheEnabled)return null;const t=this.cache.get(e);return t&&this.isCacheValid(t.timestamp)?t.data:(t&&this.cache.delete(e),null)}setCachedData(e,t){this.cacheEnabled&&this.cache.set(e,{data:t,timestamp:Date.now()})}async getAyahTranslation(e,t){const a=this.generateCacheKey("getAyahTranslation",{surahNo:e,ayahNo:t}),n=this.getCachedData(a);if(n)return n;if(this.pendingRequests.has(a))return this.pendingRequests.get(a);const r=this._getAyahTranslationInternal(e,t,a);this.pendingRequests.set(a,r);try{return await r}finally{this.pendingRequests.delete(a)}}async _getAyahTranslationInternal(e,t,a){try{const n=await h.getTranslation(this.language,e,t),r=n?.translation_text??n?.translation??"";return this.setCachedData(a,r),r}catch(n){throw console.error(`❌ Urdu translation API failed for ${e}:${t}:`,n),n}}async getSurahTranslations(e,t={}){const a=t&&(t.page!==void 0||t.limit!==void 0),n=Number.isInteger(t.page)&&t.page>0?t.page:1,r=Number.isInteger(t.limit)&&t.limit>0?t.limit:p,i=Math.min(r,m),s=this.generateCacheKey("getSurahTranslations",a?{surahNo:e,page:n,limit:i}:{surahNo:e}),o=this.getCachedData(s);if(o)return o;if(this.pendingRequests.has(s))return this.pendingRequests.get(s);const c=this._getSurahTranslationsInternal(e,s,{page:n,limit:i,hasPagination:a});this.pendingRequests.set(s,c);try{return await c}finally{this.pendingRequests.delete(s)}}async _getSurahTranslationsInternal(e,t,{page:a,limit:n,hasPagination:r}){try{const i=r?{page:a,limit:n}:{},s=await h.getSurahTranslations(this.language,e,i),o=Array.isArray(s?.translations)?s.translations.map(l=>({number:l.verse_number,ArabicText:"",Translation:l.translation_text??""})):[];if(o.forEach(l=>{const d=this.generateCacheKey("getAyahTranslation",{surahNo:e,ayahNo:l.number});l.Translation&&this.setCachedData(d,l.Translation)}),!r)return this.setCachedData(t,o),o;const c=s?.pagination?{page:s.pagination.page??a,limit:s.pagination.limit??n,totalItems:s.pagination.totalItems??s.pagination.total??null,totalPages:s.pagination.totalPages??null,hasNext:s.pagination.hasNext??!1,hasPrev:s.pagination.hasPrev??a>1,from:s.pagination.from??null,to:s.pagination.to??null}:{page:a,limit:n,totalItems:s?.count??null,totalPages:s?.count?Math.ceil(s.count/n):null,hasNext:o.length===n,hasPrev:a>1,from:o[0]?.number??null,to:o[o.length-1]?.number??null},u={translations:o,pagination:c};return this.setCachedData(t,u),u}catch(i){throw console.error(`❌ Urdu surah translation API failed for ${e}:`,i),i}}async getWordByWordData(e,t){const a=this.generateCacheKey("getWordByWordData",{surahNo:e,ayahNo:t}),n=this.getCachedData(a);if(n)return n;if(this.pendingRequests.has(a))return this.pendingRequests.get(a);const r=this._getWordByWordDataInternal(e,t,a);this.pendingRequests.set(a,r);try{return await r}finally{this.pendingRequests.delete(a)}}async _getWordByWordDataInternal(e,t,a){try{const n=await h.getWordByWord(this.language,e,t),r=Array.isArray(n?.words)?n.words:[];if(r.length===0)return console.warn(`⚠️ No Urdu word-by-word data for ${e}:${t}`),[];const i=r.map((s,o)=>({id:s.id??s.WordId??s.word_id??o+1,position:s.position??s.WordId??s.word_id??o+1,audio_url:s.audio_url??null,char_type_name:s.char_type_name??"word",code_v1:s.code_v1??"",code_v2:s.code_v2??"",line_number:s.line_number??1,page_number:s.page_number??1,text_uthmani:s.text_uthmani??"",text_simple:s.text_simple??"",translation:{text:s.translation?.text??s.WordMeaning??"",language_name:s.translation?.language_name??"Urdu",resource_name:s.translation?.resource_name??"Thafheem Urdu Word Database"},transliteration:{text:s.transliteration?.text??s.WordPhrase??"",language_name:s.transliteration?.language_name??"Urdu"}}));return this.setCachedData(a,i),i}catch(n){throw console.error(`❌ Urdu word-by-word API failed for ${e}:${t}:`,n),n}}async getFootnoteExplanation(e){const t=this.generateCacheKey("getFootnoteExplanation",{footnoteId:e}),a=this.getCachedData(t);if(a)return a;if(this.pendingRequests.has(t))return this.pendingRequests.get(t);const n=this._getFootnoteExplanationInternal(e,t);this.pendingRequests.set(t,n);try{return await n}finally{this.pendingRequests.delete(t)}}async _getFootnoteExplanationInternal(e,t){try{const n=(await h.makeRequest(`/urdu/footnote/${e}`))?.footnote_text??"Explanation not available";return this.setCachedData(t,n),n}catch(a){const n=a?.message||"";if(n.includes("Footnote not found")||n.includes("404"))return console.warn(`⚠️ Urdu footnote ${e} not found in API, skipping.`),this.setCachedData(t,null),null;throw console.error(`❌ Urdu footnote API failed for ${e}:`,a),a}}async getAllExplanations(e,t){const a=this.generateCacheKey("getAllExplanations",{surahNo:e,ayahNo:t}),n=this.getCachedData(a);if(n)return n;if(this.pendingRequests.has(a))return this.pendingRequests.get(a);const r=this._getAllExplanationsInternal(e,t,a);this.pendingRequests.set(a,r);try{return await r}finally{this.pendingRequests.delete(a)}}async _getAllExplanationsInternal(e,t,a){try{const n=await this.getAyahTranslation(e,t);if(!n||n.trim()==="")return this.setCachedData(a,[]),[];const r=await this.extractExplanationsFromFootnotes(n,e,t);return this.setCachedData(a,r),r}catch(n){throw console.error(`❌ Urdu explanations failed for ${e}:${t}:`,n),n}}async getExplanation(e,t){const a=await this.getAllExplanations(e,t);return a.length>0?a[0].explanation:await this.getAyahTranslation(e,t)||"N/A"}async extractExplanationsFromFootnotes(e,t,a){const n=[];if(!e)return n;const r=/<sup[^>]*foot_note="([^"]+)"[^>]*>(\d+)<\/sup>/g,i=new Map;let s;for(;(s=r.exec(e))!==null;){const c=s[1],u=parseInt(s[2],10),l=this.getOrAssignFootnoteNumber(t,c,u);i.has(c)||i.set(c,l??u??i.size+1)}const o=Array.from(i.entries()).sort((c,u)=>c[1]-u[1]);for(const[c,u]of o)try{const l=await this.getFootnoteExplanation(c);if(l&&l.trim()!==""&&l!=="Explanation not available"){const d=this.getOrAssignFootnoteNumber(t,c,u);n.push({explanation:l,explanation_no:d??u})}}catch(l){console.warn(`⚠️ Unable to load Urdu explanation for footnote ${c}:`,l)}return n}parseUrduTranslationWithClickableFootnotes(e,t,a){if(!e)return"";const n=document.createElement("div");return n.innerHTML=e,n.querySelectorAll("sup[foot_note]").forEach(i=>{const s=i.getAttribute("foot_note"),o=i.textContent.trim();if(s&&/^\d+$/.test(o)){const c=parseInt(o,10),u=this.getOrAssignFootnoteNumber(t,s,c),l=Number.isFinite(u)?u:c;i.style.cssText=`
          cursor: pointer !important;
          background-color: #19B5DD !important;
          color: #ffffff !important;
          font-weight: 500 !important;
          text-decoration: none !important;
          border: none !important;
          margin: 0 4px !important;
          display: inline-flex !important;
          align-items: center !important;
          justify-content: center !important;
          font-size: 12px !important;
          vertical-align: middle !important;
          line-height: 22px !important;
          width: 22px !important;
          height: 22px !important;
          border-radius: 9999px !important;
          position: relative !important;
          top: 0 !important;
          text-align: center !important;
          transition: all 0.2s ease-in-out !important;
        `,i.setAttribute("data-footnote-id",s),i.setAttribute("data-footnote-number",l),i.setAttribute("data-surah",t),i.setAttribute("data-ayah",a),i.setAttribute("title",`Click to view explanation ${l}`),i.className="urdu-footnote-link",i.removeAttribute("foot_note"),i.textContent=l}}),n.innerHTML}async fetchBlockwiseUrdu(e,t,a){const n=this.generateCacheKey("fetchBlockwiseUrdu",{surahNo:e,startAyah:t,endAyah:a}),r=this.getCachedData(n);if(r)return r;const i=[];for(let o=t;o<=a;o++)i.push(o);const s=await Promise.all(i.map(async o=>({ayah:o,translation:await this.getAyahTranslation(e,o)})));return this.setCachedData(n,s),s}async isAvailable(){try{return await h.checkLanguageHealth(this.language),!0}catch(e){return console.error("❌ Urdu service not available:",e),!1}}clearCache(){this.cache.clear(),this.pendingRequests.clear()}destroy(){this.clearCache()}getCacheStats(){return{cacheSize:this.cache.size,pendingRequests:this.pendingRequests.size,cacheEnabled:this.cacheEnabled,cacheTtl:this.cacheTtl,mode:"API-only"}}}const A=new f;export{A as default};
