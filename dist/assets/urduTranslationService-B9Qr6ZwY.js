import{A as d}from"./index-D80Klju5.js";import{a as h}from"./apiService-BNSE2PAx.js";import"./react-vendor-v5ei6ytj.js";const p=40,m=200;class f{constructor(){this.language="urdu",this.apiBasePath=d,this.pendingRequests=new Map,this.cache=new Map,this.cacheEnabled=!0,this.cacheTtl=3e5,this.footnoteOrderMap=new Map}normalizeSurahNo(e){const t=Number.parseInt(e,10);return Number.isFinite(t)?t:null}resetFootnoteOrdering(e){if(e==null){this.footnoteOrderMap.clear();return}const t=this.normalizeSurahNo(e);t!==null&&this.footnoteOrderMap.delete(t)}getOrAssignFootnoteNumber(e,t,a){if(!t)return Number.isFinite(a)?a:null;const n=this.normalizeSurahNo(e);if(n===null)return Number.isFinite(a)?a:null;this.footnoteOrderMap.has(n)||this.footnoteOrderMap.set(n,new Map);const s=this.footnoteOrderMap.get(n);if(s.has(t))return s.get(t);const i=s.size+1;return s.set(t,i),i}generateCacheKey(e,t){const a=Object.keys(t).sort().map(n=>`${n}=${t[n]}`).join("&");return`${e}${a?`?${a}`:""}`}isCacheValid(e){return Date.now()-e<this.cacheTtl}getCachedData(e){if(!this.cacheEnabled)return null;const t=this.cache.get(e);return t&&this.isCacheValid(t.timestamp)?t.data:(t&&this.cache.delete(e),null)}setCachedData(e,t){this.cacheEnabled&&this.cache.set(e,{data:t,timestamp:Date.now()})}async getAyahTranslation(e,t){const a=this.generateCacheKey("getAyahTranslation",{surahNo:e,ayahNo:t}),n=this.getCachedData(a);if(n)return n;if(this.pendingRequests.has(a))return this.pendingRequests.get(a);const s=this._getAyahTranslationInternal(e,t,a);this.pendingRequests.set(a,s);try{return await s}finally{this.pendingRequests.delete(a)}}async _getAyahTranslationInternal(e,t,a){try{const n=await h.getTranslation(this.language,e,t),s=n?.translation_text??n?.translation??"";return this.setCachedData(a,s),s}catch(n){throw console.error(`❌ Urdu translation API failed for ${e}:${t}:`,n),n}}async getSurahTranslations(e,t={}){const a=t&&(t.page!==void 0||t.limit!==void 0),n=Number.isInteger(t.page)&&t.page>0?t.page:1,s=Number.isInteger(t.limit)&&t.limit>0?t.limit:p,i=Math.min(s,m),r=this.generateCacheKey("getSurahTranslations",a?{surahNo:e,page:n,limit:i}:{surahNo:e}),o=this.getCachedData(r);if(o)return o;if(this.pendingRequests.has(r))return this.pendingRequests.get(r);const c=this._getSurahTranslationsInternal(e,r,{page:n,limit:i,hasPagination:a});this.pendingRequests.set(r,c);try{return await c}finally{this.pendingRequests.delete(r)}}async _getSurahTranslationsInternal(e,t,{page:a,limit:n,hasPagination:s}){try{const i=s?{page:a,limit:n}:{},r=await h.getSurahTranslations(this.language,e,i),o=Array.isArray(r?.translations)?r.translations.map(l=>({number:l.verse_number,ArabicText:"",Translation:l.translation_text??""})):[];if(o.forEach(l=>{const g=this.generateCacheKey("getAyahTranslation",{surahNo:e,ayahNo:l.number});l.Translation&&this.setCachedData(g,l.Translation)}),!s)return this.setCachedData(t,o),o;const c=r?.pagination?{page:r.pagination.page??a,limit:r.pagination.limit??n,totalItems:r.pagination.totalItems??r.pagination.total??null,totalPages:r.pagination.totalPages??null,hasNext:r.pagination.hasNext??!1,hasPrev:r.pagination.hasPrev??a>1,from:r.pagination.from??null,to:r.pagination.to??null}:{page:a,limit:n,totalItems:r?.count??null,totalPages:r?.count?Math.ceil(r.count/n):null,hasNext:o.length===n,hasPrev:a>1,from:o[0]?.number??null,to:o[o.length-1]?.number??null},u={translations:o,pagination:c};return this.setCachedData(t,u),u}catch(i){throw console.error(`❌ Urdu surah translation API failed for ${e}:`,i),i}}async getWordByWordData(e,t){const a=this.generateCacheKey("getWordByWordData",{surahNo:e,ayahNo:t}),n=this.getCachedData(a);if(n)return n;if(this.pendingRequests.has(a))return this.pendingRequests.get(a);const s=this._getWordByWordDataInternal(e,t,a);this.pendingRequests.set(a,s);try{return await s}finally{this.pendingRequests.delete(a)}}async _getWordByWordDataInternal(e,t,a){try{const n=await h.getWordByWord(this.language,e,t),s=Array.isArray(n?.words)?n.words:[];if(s.length===0)return console.warn(`⚠️ No Urdu word-by-word data for ${e}:${t}`),[];const i=s.map((r,o)=>({id:r.id??r.WordId??r.word_id??o+1,position:r.position??r.WordId??r.word_id??o+1,audio_url:r.audio_url??null,char_type_name:r.char_type_name??"word",code_v1:r.code_v1??"",code_v2:r.code_v2??"",line_number:r.line_number??1,page_number:r.page_number??1,text_uthmani:r.text_uthmani??"",text_simple:r.text_simple??"",translation:{text:r.translation?.text??r.WordMeaning??"",language_name:r.translation?.language_name??"Urdu",resource_name:r.translation?.resource_name??"Thafheem Urdu Word Database"},transliteration:{text:r.transliteration?.text??r.WordPhrase??"",language_name:r.transliteration?.language_name??"Urdu"}}));return this.setCachedData(a,i),i}catch(n){throw console.error(`❌ Urdu word-by-word API failed for ${e}:${t}:`,n),n}}async getFootnoteExplanation(e){const t=this.generateCacheKey("getFootnoteExplanation",{footnoteId:e}),a=this.getCachedData(t);if(a)return a;if(this.pendingRequests.has(t))return this.pendingRequests.get(t);const n=this._getFootnoteExplanationInternal(e,t);this.pendingRequests.set(t,n);try{return await n}finally{this.pendingRequests.delete(t)}}async _getFootnoteExplanationInternal(e,t){try{const n=(await h.makeRequest(`/urdu/footnote/${e}`))?.footnote_text??"Explanation not available";return this.setCachedData(t,n),n}catch(a){const n=a?.message||"";if(n.includes("Footnote not found")||n.includes("404"))return console.warn(`⚠️ Urdu footnote ${e} not found in API, skipping.`),this.setCachedData(t,null),null;throw console.error(`❌ Urdu footnote API failed for ${e}:`,a),a}}async getAllExplanations(e,t){const a=this.generateCacheKey("getAllExplanations",{surahNo:e,ayahNo:t}),n=this.getCachedData(a);if(n)return n;if(this.pendingRequests.has(a))return this.pendingRequests.get(a);const s=this._getAllExplanationsInternal(e,t,a);this.pendingRequests.set(a,s);try{return await s}finally{this.pendingRequests.delete(a)}}async _getAllExplanationsInternal(e,t,a){try{const n=await this.getAyahTranslation(e,t);if(!n||n.trim()==="")return this.setCachedData(a,[]),[];const s=await this.extractExplanationsFromFootnotes(n,e,t);return this.setCachedData(a,s),s}catch(n){throw console.error(`❌ Urdu explanations failed for ${e}:${t}:`,n),n}}async getExplanation(e,t){const a=await this.getAllExplanations(e,t);return a.length>0?a[0].explanation:await this.getAyahTranslation(e,t)||"N/A"}async extractExplanationsFromFootnotes(e,t,a){const n=[];if(!e)return n;const s=/<sup[^>]*foot_note="([^"]+)"[^>]*>(\d+)<\/sup>/g,i=new Map;let r;for(;(r=s.exec(e))!==null;){const c=r[1],u=parseInt(r[2],10),l=this.getOrAssignFootnoteNumber(t,c,u);i.has(c)||i.set(c,l??u??i.size+1)}const o=Array.from(i.entries()).sort((c,u)=>c[1]-u[1]);for(const[c,u]of o)try{const l=await this.getFootnoteExplanation(c);if(l&&l.trim()!==""&&l!=="Explanation not available"){const g=this.getOrAssignFootnoteNumber(t,c,u);n.push({explanation:l,explanation_no:g??u})}}catch(l){console.warn(`⚠️ Unable to load Urdu explanation for footnote ${c}:`,l)}return n}parseUrduTranslationWithClickableFootnotes(e,t,a){if(!e)return"";const n=document.createElement("div");return n.innerHTML=e,n.querySelectorAll("sup[foot_note]").forEach(i=>{const r=i.getAttribute("foot_note"),o=i.textContent.trim();if(r&&/^\d+$/.test(o)){const c=parseInt(o,10),u=this.getOrAssignFootnoteNumber(t,r,c),l=Number.isFinite(u)?u:c;i.style.cssText=`
          cursor: pointer !important;
          background-color: rgb(41, 169, 199) !important;
          color: rgb(255, 255, 255) !important;
          font-weight: 600 !important;
          text-decoration: none !important;
          border: none !important;
          display: inline-flex !important;
          align-items: center !important;
          justify-content: center !important;
          font-size: 12px !important;
          vertical-align: middle !important;
          line-height: 1 !important;
          border-radius: 9999px !important;
          position: relative !important;
          z-index: 10 !important;
          top: 0px !important;
          min-width: 20px !important;
          min-height: 19px !important;
          text-align: center !important;
          transition: 0.2s ease-in-out !important;
          padding: 0 !important;
          margin-right: 4px;
          margin-left: -1px;
          margin-top: -15px;
        `,i.setAttribute("data-footnote-id",r),i.setAttribute("data-footnote-number",l),i.setAttribute("data-surah",t),i.setAttribute("data-ayah",a),i.setAttribute("title",`Click to view explanation ${l}`),i.className="urdu-footnote-link",i.removeAttribute("foot_note"),i.textContent=l}}),n.innerHTML}async fetchBlockwiseUrdu(e,t,a){const n=this.generateCacheKey("fetchBlockwiseUrdu",{surahNo:e,startAyah:t,endAyah:a}),s=this.getCachedData(n);if(s)return s;const i=[];for(let o=t;o<=a;o++)i.push(o);const r=await Promise.all(i.map(async o=>({ayah:o,translation:await this.getAyahTranslation(e,o)})));return this.setCachedData(n,r),r}async isAvailable(){try{return await h.checkLanguageHealth(this.language),!0}catch(e){return console.error("❌ Urdu service not available:",e),!1}}clearCache(){this.cache.clear(),this.pendingRequests.clear()}destroy(){this.clearCache()}getCacheStats(){return{cacheSize:this.cache.size,pendingRequests:this.pendingRequests.size,cacheEnabled:this.cacheEnabled,cacheTtl:this.cacheTtl,mode:"API-only"}}}const A=new f;export{A as default};
