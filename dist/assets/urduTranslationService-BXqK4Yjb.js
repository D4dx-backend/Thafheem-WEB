import{ah as d,ai as p,aj as g,ak as f}from"./index-BMIAMJ2S.js";import{a as u}from"./apiService-xUHHIAvd.js";class m{constructor(){this.language="urdu",this.useApi=d,this.apiBasePath=p,this.cacheEnabled=g,this.cacheTtl=f,this.cache=new Map,this.pendingRequests=new Map}_assertApiEnabled(){if(!this.useApi)throw new Error("Urdu API is disabled (VITE_USE_API=false).")}generateCacheKey(a,e){const n=Object.keys(e).sort().map(t=>`${t}=${e[t]}`).join("&");return`${a}${n?`?${n}`:""}`}isCacheValid(a){return Date.now()-a<this.cacheTtl}getCachedData(a){if(!this.cacheEnabled)return null;const e=this.cache.get(a);return e&&this.isCacheValid(e.timestamp)?e.data:(e&&this.cache.delete(a),null)}setCachedData(a,e){this.cacheEnabled&&this.cache.set(a,{data:e,timestamp:Date.now()})}async getAyahTranslation(a,e){const n=this.generateCacheKey("getAyahTranslation",{surahNo:a,ayahNo:e}),t=this.getCachedData(n);if(t)return t;if(this.pendingRequests.has(n))return this.pendingRequests.get(n);const s=this._getAyahTranslationInternal(a,e,n);this.pendingRequests.set(n,s);try{return await s}finally{this.pendingRequests.delete(n)}}async _getAyahTranslationInternal(a,e,n){this._assertApiEnabled();try{const t=await u.getTranslation(this.language,a,e),s=t?.translation_text??t?.translation??"";return this.setCachedData(n,s),s}catch(t){throw console.error(`❌ Urdu translation API failed for ${a}:${e}:`,t),t}}async getSurahTranslations(a){const e=this.generateCacheKey("getSurahTranslations",{surahNo:a}),n=this.getCachedData(e);if(n)return n;if(this.pendingRequests.has(e))return this.pendingRequests.get(e);const t=this._getSurahTranslationsInternal(a,e);this.pendingRequests.set(e,t);try{return await t}finally{this.pendingRequests.delete(e)}}async _getSurahTranslationsInternal(a,e){this._assertApiEnabled();try{const n=await u.getSurahTranslations(this.language,a),t=Array.isArray(n?.translations)?n.translations.map(s=>({verse_number:s.verse_number,translation_text:s.translation_text??""})):[];return t.forEach(s=>{const i=this.generateCacheKey("getAyahTranslation",{surahNo:a,ayahNo:s.verse_number});s.translation_text&&this.setCachedData(i,s.translation_text)}),this.setCachedData(e,t),t}catch(n){throw console.error(`❌ Urdu surah translation API failed for ${a}:`,n),n}}async getWordByWordData(a,e){const n=this.generateCacheKey("getWordByWordData",{surahNo:a,ayahNo:e}),t=this.getCachedData(n);if(t)return t;if(this.pendingRequests.has(n))return this.pendingRequests.get(n);const s=this._getWordByWordDataInternal(a,e,n);this.pendingRequests.set(n,s);try{return await s}finally{this.pendingRequests.delete(n)}}async _getWordByWordDataInternal(a,e,n){this._assertApiEnabled();try{const t=await u.getWordByWord(this.language,a,e),s=Array.isArray(t?.words)?t.words:[];if(s.length===0)return console.warn(`⚠️ No Urdu word-by-word data for ${a}:${e}`),[];const i=s.map((r,o)=>({id:r.id??r.WordId??r.word_id??o+1,position:r.position??r.WordId??r.word_id??o+1,audio_url:r.audio_url??null,char_type_name:r.char_type_name??"word",code_v1:r.code_v1??"",code_v2:r.code_v2??"",line_number:r.line_number??1,page_number:r.page_number??1,text_uthmani:r.text_uthmani??"",text_simple:r.text_simple??"",translation:{text:r.translation?.text??r.WordMeaning??"",language_name:r.translation?.language_name??"Urdu",resource_name:r.translation?.resource_name??"Thafheem Urdu Word Database"},transliteration:{text:r.transliteration?.text??r.WordPhrase??"",language_name:r.transliteration?.language_name??"Urdu"}}));return this.setCachedData(n,i),i}catch(t){throw console.error(`❌ Urdu word-by-word API failed for ${a}:${e}:`,t),t}}async getFootnoteExplanation(a){const e=this.generateCacheKey("getFootnoteExplanation",{footnoteId:a}),n=this.getCachedData(e);if(n)return n;if(this.pendingRequests.has(e))return this.pendingRequests.get(e);const t=this._getFootnoteExplanationInternal(a,e);this.pendingRequests.set(e,t);try{return await t}finally{this.pendingRequests.delete(e)}}async _getFootnoteExplanationInternal(a,e){this._assertApiEnabled();try{const t=(await u.makeRequest(`/urdu/footnote/${a}`))?.footnote_text??"Explanation not available";return this.setCachedData(e,t),t}catch(n){const t=n?.message||"";if(t.includes("Footnote not found")||t.includes("404"))return console.warn(`⚠️ Urdu footnote ${a} not found in API, skipping.`),this.setCachedData(e,null),null;throw console.error(`❌ Urdu footnote API failed for ${a}:`,n),n}}async getAllExplanations(a,e){const n=this.generateCacheKey("getAllExplanations",{surahNo:a,ayahNo:e}),t=this.getCachedData(n);if(t)return t;if(this.pendingRequests.has(n))return this.pendingRequests.get(n);const s=this._getAllExplanationsInternal(a,e,n);this.pendingRequests.set(n,s);try{return await s}finally{this.pendingRequests.delete(n)}}async _getAllExplanationsInternal(a,e,n){try{const t=await this.getAyahTranslation(a,e);if(!t||t.trim()==="")return this.setCachedData(n,[]),[];const s=await this.extractExplanationsFromFootnotes(t,a,e);return this.setCachedData(n,s),s}catch(t){throw console.error(`❌ Urdu explanations failed for ${a}:${e}:`,t),t}}async getExplanation(a,e){const n=await this.getAllExplanations(a,e);return n.length>0?n[0].explanation:await this.getAyahTranslation(a,e)||"N/A"}async extractExplanationsFromFootnotes(a,e,n){const t=[];if(!a)return t;const s=/<sup[^>]*foot_note="([^"]+)"[^>]*>(\d+)<\/sup>/g,i=new Map;let r;for(;(r=s.exec(a))!==null;){const c=r[1],h=parseInt(r[2],10);i.has(c)||i.set(c,h)}const o=Array.from(i.entries()).sort((c,h)=>c[1]-h[1]);for(const[c,h]of o)try{const l=await this.getFootnoteExplanation(c);l&&l.trim()!==""&&l!=="Explanation not available"&&t.push({explanation:l,explanation_no:h})}catch(l){console.warn(`⚠️ Unable to load Urdu explanation for footnote ${c}:`,l)}return t}parseUrduTranslationWithClickableFootnotes(a,e,n){if(!a)return"";const t=document.createElement("div");return t.innerHTML=a,t.querySelectorAll("sup[foot_note]").forEach(i=>{const r=i.getAttribute("foot_note"),o=i.textContent.trim();r&&/^\d+$/.test(o)&&(i.style.cssText=`
          cursor: pointer !important;
          background-color: #19B5DD !important;
          color: #ffffff !important;
          font-weight: 500 !important;
          text-decoration: none !important;
          border: none !important;
          padding: 4px 8px !important;
          margin: 0 4px !important;
          display: inline-flex !important;
          align-items: center !important;
          justify-content: center !important;
          font-size: 12px !important;
          vertical-align: middle !important;
          line-height: 1 !important;
          border-radius: 8px !important;
          position: relative !important;
          top: 0 !important;
          min-width: 20px !important;
          min-height: 20px !important;
          text-align: center !important;
          transition: all 0.2s ease-in-out !important;
        `,i.setAttribute("data-footnote-id",r),i.setAttribute("data-footnote-number",o),i.setAttribute("data-surah",e),i.setAttribute("data-ayah",n),i.setAttribute("title",`Click to view explanation ${o}`),i.className="urdu-footnote-link",i.removeAttribute("foot_note"))}),t.innerHTML}async fetchBlockwiseUrdu(a,e,n){const t=this.generateCacheKey("fetchBlockwiseUrdu",{surahNo:a,startAyah:e,endAyah:n}),s=this.getCachedData(t);if(s)return s;const i=[];for(let o=e;o<=n;o++)i.push(o);const r=await Promise.all(i.map(async o=>({ayah:o,translation:await this.getAyahTranslation(a,o)})));return this.setCachedData(t,r),r}async isAvailable(){try{return this._assertApiEnabled(),await u.checkLanguageHealth(this.language),!0}catch(a){return console.error("❌ Urdu service not available:",a),!1}}clearCache(){this.cache.clear(),this.pendingRequests.clear()}destroy(){this.clearCache()}getCacheStats(){return{cacheSize:this.cache.size,pendingRequests:this.pendingRequests.size,cacheEnabled:this.cacheEnabled,cacheTtl:this.cacheTtl,mode:"API-only"}}}const A=new m;export{A as default};
