import{aj as d,ak as p}from"./index-D2bCerlO.js";import{a as u}from"./apiService-CutSZesJ.js";class g{constructor(){this.language="urdu",this.useApi=d,this.apiBasePath=p,this.pendingRequests=new Map}_assertApiEnabled(){if(!this.useApi)throw new Error("Urdu API is disabled (VITE_USE_API=false).")}generateCacheKey(n,e){const a=Object.keys(e).sort().map(t=>`${t}=${e[t]}`).join("&");return`${n}${a?`?${a}`:""}`}isCacheValid(n){return Date.now()-n<this.cacheTtl}getCachedData(n){if(!this.cacheEnabled)return null;const e=this.cache.get(n);return e&&this.isCacheValid(e.timestamp)?e.data:(e&&this.cache.delete(n),null)}setCachedData(n,e){this.cacheEnabled&&this.cache.set(n,{data:e,timestamp:Date.now()})}async getAyahTranslation(n,e){const a=this.generateCacheKey("getAyahTranslation",{surahNo:n,ayahNo:e}),t=this.getCachedData(a);if(t)return t;if(this.pendingRequests.has(a))return this.pendingRequests.get(a);const s=this._getAyahTranslationInternal(n,e,a);this.pendingRequests.set(a,s);try{return await s}finally{this.pendingRequests.delete(a)}}async _getAyahTranslationInternal(n,e,a){this._assertApiEnabled();try{const t=await u.getTranslation(this.language,n,e),s=t?.translation_text??t?.translation??"";return this.setCachedData(a,s),s}catch(t){throw console.error(`❌ Urdu translation API failed for ${n}:${e}:`,t),t}}async getSurahTranslations(n){const e=this.generateCacheKey("getSurahTranslations",{surahNo:n}),a=this.getCachedData(e);if(a)return a;if(this.pendingRequests.has(e))return this.pendingRequests.get(e);const t=this._getSurahTranslationsInternal(n,e);this.pendingRequests.set(e,t);try{return await t}finally{this.pendingRequests.delete(e)}}async _getSurahTranslationsInternal(n,e){this._assertApiEnabled();try{const a=await u.getSurahTranslations(this.language,n),t=Array.isArray(a?.translations)?a.translations.map(s=>({verse_number:s.verse_number,translation_text:s.translation_text??""})):[];return t.forEach(s=>{const i=this.generateCacheKey("getAyahTranslation",{surahNo:n,ayahNo:s.verse_number});s.translation_text&&this.setCachedData(i,s.translation_text)}),this.setCachedData(e,t),t}catch(a){throw console.error(`❌ Urdu surah translation API failed for ${n}:`,a),a}}async getWordByWordData(n,e){const a=this.generateCacheKey("getWordByWordData",{surahNo:n,ayahNo:e}),t=this.getCachedData(a);if(t)return t;if(this.pendingRequests.has(a))return this.pendingRequests.get(a);const s=this._getWordByWordDataInternal(n,e,a);this.pendingRequests.set(a,s);try{return await s}finally{this.pendingRequests.delete(a)}}async _getWordByWordDataInternal(n,e,a){this._assertApiEnabled();try{const t=await u.getWordByWord(this.language,n,e),s=Array.isArray(t?.words)?t.words:[];if(s.length===0)return console.warn(`⚠️ No Urdu word-by-word data for ${n}:${e}`),[];const i=s.map((r,o)=>({id:r.id??r.WordId??r.word_id??o+1,position:r.position??r.WordId??r.word_id??o+1,audio_url:r.audio_url??null,char_type_name:r.char_type_name??"word",code_v1:r.code_v1??"",code_v2:r.code_v2??"",line_number:r.line_number??1,page_number:r.page_number??1,text_uthmani:r.text_uthmani??"",text_simple:r.text_simple??"",translation:{text:r.translation?.text??r.WordMeaning??"",language_name:r.translation?.language_name??"Urdu",resource_name:r.translation?.resource_name??"Thafheem Urdu Word Database"},transliteration:{text:r.transliteration?.text??r.WordPhrase??"",language_name:r.transliteration?.language_name??"Urdu"}}));return this.setCachedData(a,i),i}catch(t){throw console.error(`❌ Urdu word-by-word API failed for ${n}:${e}:`,t),t}}async getFootnoteExplanation(n){const e=this.generateCacheKey("getFootnoteExplanation",{footnoteId:n}),a=this.getCachedData(e);if(a)return a;if(this.pendingRequests.has(e))return this.pendingRequests.get(e);const t=this._getFootnoteExplanationInternal(n,e);this.pendingRequests.set(e,t);try{return await t}finally{this.pendingRequests.delete(e)}}async _getFootnoteExplanationInternal(n,e){this._assertApiEnabled();try{const t=(await u.makeRequest(`/urdu/footnote/${n}`))?.footnote_text??"Explanation not available";return this.setCachedData(e,t),t}catch(a){const t=a?.message||"";if(t.includes("Footnote not found")||t.includes("404"))return console.warn(`⚠️ Urdu footnote ${n} not found in API, skipping.`),this.setCachedData(e,null),null;throw console.error(`❌ Urdu footnote API failed for ${n}:`,a),a}}async getAllExplanations(n,e){const a=this.generateCacheKey("getAllExplanations",{surahNo:n,ayahNo:e}),t=this.getCachedData(a);if(t)return t;if(this.pendingRequests.has(a))return this.pendingRequests.get(a);const s=this._getAllExplanationsInternal(n,e,a);this.pendingRequests.set(a,s);try{return await s}finally{this.pendingRequests.delete(a)}}async _getAllExplanationsInternal(n,e,a){try{const t=await this.getAyahTranslation(n,e);if(!t||t.trim()==="")return this.setCachedData(a,[]),[];const s=await this.extractExplanationsFromFootnotes(t,n,e);return this.setCachedData(a,s),s}catch(t){throw console.error(`❌ Urdu explanations failed for ${n}:${e}:`,t),t}}async getExplanation(n,e){const a=await this.getAllExplanations(n,e);return a.length>0?a[0].explanation:await this.getAyahTranslation(n,e)||"N/A"}async extractExplanationsFromFootnotes(n,e,a){const t=[];if(!n)return t;const s=/<sup[^>]*foot_note="([^"]+)"[^>]*>(\d+)<\/sup>/g,i=new Map;let r;for(;(r=s.exec(n))!==null;){const c=r[1],h=parseInt(r[2],10);i.has(c)||i.set(c,h)}const o=Array.from(i.entries()).sort((c,h)=>c[1]-h[1]);for(const[c,h]of o)try{const l=await this.getFootnoteExplanation(c);l&&l.trim()!==""&&l!=="Explanation not available"&&t.push({explanation:l,explanation_no:h})}catch(l){console.warn(`⚠️ Unable to load Urdu explanation for footnote ${c}:`,l)}return t}parseUrduTranslationWithClickableFootnotes(n,e,a){if(!n)return"";const t=document.createElement("div");return t.innerHTML=n,t.querySelectorAll("sup[foot_note]").forEach(i=>{const r=i.getAttribute("foot_note"),o=i.textContent.trim();r&&/^\d+$/.test(o)&&(i.style.cssText=`
          cursor: pointer !important;
          background-color: #19B5DD !important;
          color: #ffffff !important;
          font-weight: 500 !important;
          text-decoration: none !important;
          border: none !important;
          padding: 4px 8px !important;
          margin: 0 4px !important;
          display: inline-flex !important;
          align-items: center !important;
          justify-content: center !important;
          font-size: 12px !important;
          vertical-align: middle !important;
          line-height: 1 !important;
          border-radius: 8px !important;
          position: relative !important;
          top: 0 !important;
          min-width: 20px !important;
          min-height: 20px !important;
          text-align: center !important;
          transition: all 0.2s ease-in-out !important;
        `,i.setAttribute("data-footnote-id",r),i.setAttribute("data-footnote-number",o),i.setAttribute("data-surah",e),i.setAttribute("data-ayah",a),i.setAttribute("title",`Click to view explanation ${o}`),i.className="urdu-footnote-link",i.removeAttribute("foot_note"))}),t.innerHTML}async fetchBlockwiseUrdu(n,e,a){const t=this.generateCacheKey("fetchBlockwiseUrdu",{surahNo:n,startAyah:e,endAyah:a}),s=this.getCachedData(t);if(s)return s;const i=[];for(let o=e;o<=a;o++)i.push(o);const r=await Promise.all(i.map(async o=>({ayah:o,translation:await this.getAyahTranslation(n,o)})));return this.setCachedData(t,r),r}async isAvailable(){try{return this._assertApiEnabled(),await u.checkLanguageHealth(this.language),!0}catch(n){return console.error("❌ Urdu service not available:",n),!1}}clearCache(){this.cache.clear(),this.pendingRequests.clear()}destroy(){this.clearCache()}getCacheStats(){return{cacheSize:this.cache.size,pendingRequests:this.pendingRequests.size,cacheEnabled:this.cacheEnabled,cacheTtl:this.cacheTtl,mode:"API-only"}}}const _=new g;export{_ as default};
