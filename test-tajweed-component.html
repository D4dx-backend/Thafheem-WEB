<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tajweed Component Test</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .font-malayalam {
            font-family: 'Noto Sans Malayalam', sans-serif;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Malayalam:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Mock API functions for testing
        const mockTajweedRules = [
            {
                id: 1,
                RuleNo: 1,
                Rule: "വിവിധയിനം വിരാമങ്ങള്‍",
                Ruledesc: "الوقف ഭാഷാര്‍ഥം: തടഞ്ഞുവെക്കുക സാങ്കേതികാര്‍ഥം: പാരായണം തുടരണമെന്ന ഉദ്ദേശ്യത്തോടെ സാധാരണഗതിയില്‍ ശ്വാസം വിടാവുന്ന സമയം നിര്‍ത്തുക.",
                Hassub: 1,
                Examples: ""
            },
            {
                id: 2,
                RuleNo: 2,
                Rule: "ഹംസഃയുടെ ഇനങ്ങള്‍",
                Ruledesc: "ഖുര്‍ആനില്‍ വന്നിട്ടുള്ള ഹംസകള്‍ മുഴുവന്‍ ഒന്നുകില്‍ (هَمْزَةُ الْوَصْل) , അല്ലെങ്കില്‍ (هَمْزَةُ الْقَطْع) ആണ്.",
                Hassub: 1,
                Examples: ""
            },
            {
                id: 3,
                RuleNo: 4,
                Rule: "നൂനും തന്‍വീനും",
                Ruledesc: "النُّونُ السَّاكِنَة : ഹറകത്ത് (حَرْكَة) ഇല്ലാത്തതും ശേഷമുള്ള അക്ഷരത്തിനനുസരിച്ച് ഉച്ചരിക്കപ്പെടുന്നതുമായ نُون",
                Hassub: 1,
                Examples: "2:2,14:9,2:195"
            }
        ];

        const mockSubRules = [
            {
                id: 3,
                RuleNo: "1.1",
                Rule: "രണ്ടനക്ക സമയം അടങ്ങുക",
                Ruledesc: "ശ്വാസം വിടാതെ വായന തുടരാമെന്ന ഉദ്ദേശ്യത്തോടെ രണ്ടനക്ക സമയം അടങ്ങുക. س ആണ് ഇതിന്റെ അടയാളം.",
                Hassub: 0,
                Examples: "83:14,75:27,36:52"
            },
            {
                id: 4,
                RuleNo: "1.2",
                Rule: "അനനുവദനീയ വിരാമം",
                Ruledesc: "ആശയപരമായും ഭാഷാപരമായും ശേഷമുള്ളതുമായി ബന്ധപ്പെട്ടു നില്‍ക്കുന്നതും സ്വയം ആശയം പൂര്‍ണമാകാത്തതുമായ സ്ഥാനത്തുള്ള വിരാമം.",
                Hassub: 0,
                Examples: "5:53,16:32,16:76"
            }
        ];

        // Mock API functions
        const fetchAllTajweedRules = async () => {
            return new Promise(resolve => {
                setTimeout(() => resolve(mockTajweedRules), 1000);
            });
        };

        const fetchSpecificTajweedRule = async (ruleId) => {
            return new Promise(resolve => {
                setTimeout(() => resolve(mockSubRules), 500);
            });
        };

        // Mock theme context
        const useTheme = () => ({
            quranFont: 'Noto Sans Arabic'
        });

        // Simplified Tajweed component for testing
        const TajweedTest = () => {
            const [tajweedRules, setTajweedRules] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(null);
            const [expandedSections, setExpandedSections] = React.useState({});
            const { quranFont } = useTheme();

            React.useEffect(() => {
                const loadTajweedRules = async () => {
                    try {
                        setLoading(true);
                        setError(null);
                        
                        const rulesData = await fetchAllTajweedRules();
                        console.log('Loaded Tajweed rules:', rulesData);
                        
                        const rulesArray = Array.isArray(rulesData) ? rulesData : [rulesData];
                        
                        const transformedRules = rulesArray
                            .filter((rule) => rule && rule.RuleNo !== 0 && rule.Hassub === 1)
                            .map((rule, index) => ({
                                id: rule.RuleNo,
                                title: rule.Rule,
                                content: rule.Ruledesc,
                                examples: rule.Examples || '',
                                hasSubRules: rule.Hassub,
                                audioUrl: rule.AudioUrl || '',
                            }));
                        
                        console.log('Transformed rules:', transformedRules);
                        setTajweedRules(transformedRules);
                    } catch (err) {
                        console.error('Failed to load Tajweed rules:', err);
                        setError(err.message);
                    } finally {
                        setLoading(false);
                    }
                };

                loadTajweedRules();
            }, []);

            const toggleSection = async (section, ruleId) => {
                setExpandedSections((prev) => ({
                    ...prev,
                    [section]: !prev[section],
                }));

                if (!expandedSections[section] && ruleId) {
                    try {
                        const subRulesData = await fetchSpecificTajweedRule(ruleId);
                        console.log('Fetched sub-rules data:', subRulesData);
                        
                        let allExamples = '';
                        if (Array.isArray(subRulesData)) {
                            const examplesList = subRulesData
                                .filter(subRule => subRule.Examples && subRule.Examples.trim() !== '')
                                .map(subRule => subRule.Examples.trim());
                            allExamples = examplesList.join(', ');
                        }
                        
                        setTajweedRules(prevRules => 
                            prevRules.map(rule => 
                                rule.id === ruleId 
                                    ? {
                                        ...rule,
                                        examples: allExamples || rule.examples,
                                        subRules: Array.isArray(subRulesData) ? subRulesData : []
                                    }
                                    : rule
                            )
                        );
                    } catch (error) {
                        console.warn('Failed to fetch rule examples:', error);
                    }
                }
            };

            if (loading) {
                return (
                    <div className="min-h-screen bg-white flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-500 mx-auto mb-4"></div>
                            <p className="text-gray-600">Loading Tajweed Rules...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-white">
                    <div className="bg-white">
                        <div className="max-w-5xl mx-auto px-4 py-4 border-b border-gray-200">
                            <h1 className="text-lg font-semibold text-gray-800 font-malayalam">
                                ഖുർആന്‍ പാരായണ ശാസ്ത്രം (علم التجويد)
                            </h1>
                        </div>
                    </div>

                    <div className="max-w-5xl mx-auto px-4 py-6">
                        <div className="bg-white rounded-lg p-6">
                            {error && (
                                <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                                    <p className="text-yellow-800 text-sm">
                                        Failed to load Tajweed rules: {error}
                                    </p>
                                </div>
                            )}

                            <div className="space-y-6">
                                <div className="prose prose-gray max-w-none mb-8">
                                    <p className="text-sm text-gray-700 leading-relaxed mb-4 font-malayalam">
                                        അല്ലാഹു മനുഷ്യര്‍ക്ക് നല്‍കിയ ഏറ്റവും വലിയ അനുഗ്രഹമാണ് പരിശുദ്ധ ഖുര്‍ആന്‍. 
                                        അതിന്റെ പാരായണവും പഠനവും മനനവും ഏറ്റവും മഹത്തായ പ്രതിഫലവും പുണ്യവും ലഭിക്കുന്ന സല്‍കര്‍മങ്ങളില്‍ പെട്ടതാണ്.
                                    </p>
                                </div>

                                {tajweedRules.length > 0 ? (
                                    tajweedRules.map((rule, index) => (
                                        <div key={rule.id || index} className="border border-gray-200 rounded-lg">
                                            <button
                                                onClick={() => toggleSection(`rule_${index}`, rule.id)}
                                                className="w-full flex items-center justify-between p-4 text-left hover:bg-gray-50"
                                            >
                                                <h3 className="text-base font-medium text-blue-600 font-malayalam pr-2">
                                                    {rule.title}
                                                </h3>
                                                <span className="text-gray-600 flex-shrink-0">
                                                    {expandedSections[`rule_${index}`] ? '▲' : '▼'}
                                                </span>
                                            </button>
                                            {expandedSections[`rule_${index}`] && (
                                                <div className="px-4 pb-4 border-t border-gray-200">
                                                    <p className="text-sm text-gray-700 leading-relaxed mt-3 font-malayalam">
                                                        {rule.content}
                                                    </p>

                                                    {rule.subRules && rule.subRules.length > 0 && (
                                                        <div className="mt-6">
                                                            <h4 className="text-sm font-medium text-blue-600 mb-4">
                                                                ഉപനിയമങ്ങൾ:
                                                            </h4>
                                                            <div className="space-y-3">
                                                                {rule.subRules.map((subRule, subIndex) => (
                                                                    <div key={subIndex} className="bg-gray-50 p-3 rounded-lg">
                                                                        <h5 className="text-sm font-medium text-green-600 mb-2">
                                                                            {subRule.Rule}
                                                                        </h5>
                                                                        <p className="text-sm text-gray-700 font-malayalam">
                                                                            {subRule.Ruledesc}
                                                                        </p>
                                                                        {subRule.Examples && subRule.Examples.trim() !== '' && (
                                                                            <p className="text-xs text-gray-600 mt-2">
                                                                                ഉദാഹരണങ്ങൾ: {subRule.Examples}
                                                                            </p>
                                                                        )}
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}

                                                    {rule.examples && rule.examples.trim() !== '' && (
                                                        <div className="mt-6">
                                                            <h4 className="text-sm font-medium text-green-600 mb-4">
                                                                ഉദാഹരണം:
                                                            </h4>
                                                            <div className="mb-3">
                                                                <p className="text-xs text-gray-600 mb-2 font-malayalam">
                                                                    ഉദാഹരണ വാക്യങ്ങൾ:
                                                                </p>
                                                                <p className="text-sm text-gray-800 bg-gray-50 p-2 rounded">
                                                                    വാക്യ റഫറൻസുകൾ: {rule.examples}
                                                                </p>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    ))
                                ) : (
                                    !loading && (
                                        <div className="text-center py-12">
                                            <p className="text-gray-600">
                                                No Tajweed rules available at the moment.
                                            </p>
                                        </div>
                                    )
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<TajweedTest />, document.getElementById('root'));
    </script>
</body>
</html>